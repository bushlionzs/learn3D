/*$T MapServer/Server/Obj/ItemInstance.h GC 1.140 10/10/07 10:07:31 */


/*$6
 +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
 +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
 */


#ifndef _OBJ_ITEM_H_
#define _OBJ_ITEM_H_

#include "Item_Base.h"
struct ItemLogRecordInfo;

struct _OBJ_ITEM_INIT :
	public _INIT_OBJECT
{
	uint32	m_uCreateTime;
	uint32	m_uRecycleTime;
	BOOL	m_bRecycle;
	int32	m_ItemType;

	_OBJ_ITEM_INIT (void)
	{
		Clear();
	}

	/*
	 ===============================================================================================================
	 ===============================================================================================================
	 */
	virtual void Clear(void)
	{
		_INIT_OBJECT::Clear();
		m_uCreateTime = 0;
		m_uRecycleTime = 0;
		m_ItemType = 0;
		m_bRecycle = TRUE;
	}
};

class	Map;

class ItemInstance :
	public Object
{
/*
 -----------------------------------------------------------------------------------------------------------------------
 -----------------------------------------------------------------------------------------------------------------------
 */
public:
	ItemInstance();
	~	ItemInstance();

/*
 -----------------------------------------------------------------------------------------------------------------------
 -----------------------------------------------------------------------------------------------------------------------
 */
public:
	friend class	ItemInstancePool;

/*
 -----------------------------------------------------------------------------------------------------------------------
 -----------------------------------------------------------------------------------------------------------------------
 */
public:

	/*
	 ===============================================================================================================
	 ===============================================================================================================
	 */
	virtual ObjectClass GetObjType(void) const
	{
		return OBJECT_CLASS_DROP_ITEM;
	}

	virtual void	Clear();
	virtual BOOL	Init(const _INIT_OBJECT *pInit);

	virtual bool	HeartBeat(uint32 uTime = 0);

/*
 -----------------------------------------------------------------------------------------------------------------------
 -----------------------------------------------------------------------------------------------------------------------
 */
public:
	virtual NetPacket	*CreateNewObjMsg(void);
	virtual void		DestroyNewObjMsg(NetPacket*pPacket);

/*
 -----------------------------------------------------------------------------------------------------------------------
 -----------------------------------------------------------------------------------------------------------------------
 */
public:
	void	Recycle();

	/*
	 ===============================================================================================================
	 ===============================================================================================================
	 */
	uint32 GetPoolPos()
	{
		return m_nPoolPos;
	};

	void		SaveObj_Item(SItem *pItem);
	SItem		*GetObj_Item();

	inline void	SetObj_ItemID(ObjID_t id);
	inline ObjID_t	GetObj_ItemID();

	inline GUID_t	GetOwner(int32 nPos);

	/*
	 ===============================================================================================================
	 ===============================================================================================================
	 */
	inline int32 GetOwnerCount()
	{
		return m_OwnerCount;
	}

	inline void	SetOwner(GUID_t id);

	/*
	 ===============================================================================================================
	 ===============================================================================================================
	 */

	inline void SetDropObjID(ObjID_t nID)
	{
		m_DropObjID = nID;
	}

	/*
	 ===============================================================================================================
	 ===============================================================================================================
	 */
	ObjID_t GetDropObjID()
	{
		return m_DropObjID;
	}

	inline int32		GetType() const;
	inline void		SetType(int32 Type);
	inline int32		GetRecycleTimes();
	inline void		SetRecycleTimes(int32 RecycleTimes);

	ePICK_RESULT_CODE		CanPick(GUID_t PickerID, ObjID_t HumanID,SItem *pItem);
	virtual BOOL		IsCanViewMe(const Object *pObj);
	void			EnablePickOwnerTime();
	inline uint32		GetPickOwnerTime();
	void			SetPickOwnerTime(uint32 uPickTime);

	virtual ScriptID_t	GetScriptID() const;

/*
 -----------------------------------------------------------------------------------------------------------------------
 -----------------------------------------------------------------------------------------------------------------------
 */
private:
	inline void	SetPoolPos(uint32 iPos);

/*
 -----------------------------------------------------------------------------------------------------------------------
 -----------------------------------------------------------------------------------------------------------------------
 */
private:
	uint32	m_nPoolPos;
	GUID_t	m_OwnerId[MAX_TEAM_MEMBER];
	uint32	m_OwnerCount;
	ObjID_t m_DropObjID;
	ObjID_t m_Obj_ItemId;
	SItem	m_Obj_Item;
	int32	m_Obj_ItemType;
	int32	m_RecycleTimes;

/*
 -----------------------------------------------------------------------------------------------------------------------
 -----------------------------------------------------------------------------------------------------------------------
 */
private:
	int32	m_PickOwnerTime;
	uint32	m_FinalPickTime;

/*
 -----------------------------------------------------------------------------------------------------------------------
 -----------------------------------------------------------------------------------------------------------------------
 */
private:
	CTinyTimer	m_RecycleTimer;
	uint32		m_CreateTime;
	uint32		m_RecycleTime;
};

#include "ItemInstance.inl"
#endif
