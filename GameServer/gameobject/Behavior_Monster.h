/*$T MapServer/Server/AI/Behavior_Monster.h GC 1.140 10/10/07 10:07:19 */


/*$6
 +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
 +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
 */


#ifndef __MONSTERAI_H__
#define __MONSTERAI_H__

#include "TypeDefine.h"
#include "Behavior_Const.h"
#include "Behavior_Character.h"
#include "TabDefine.h"
#include "Behavior_Template.h"

class	Monster;
class	Character;

class Behavior_Monster :
	public Behavior_Character
{
/*
 -----------------------------------------------------------------------------------------------------------------------
 -----------------------------------------------------------------------------------------------------------------------
 */
public:
	Behavior_Monster();
	virtual		~Behavior_Monster();

	virtual BOOL	Init(Character *pCharacter);
	virtual void	Clear(void);
	void		Reset(void);

	/*
	 ===============================================================================================================
	 ===============================================================================================================
	 */

	Monster* GetCharacter(void) const;

/*
 -----------------------------------------------------------------------------------------------------------------------
 -----------------------------------------------------------------------------------------------------------------------
 */
protected:
	void	Init(void);

/*
 -----------------------------------------------------------------------------------------------------------------------
 -----------------------------------------------------------------------------------------------------------------------
 */
public:
	virtual void	ChangeState(eSTATE eState);

/*
 -----------------------------------------------------------------------------------------------------------------------
 -----------------------------------------------------------------------------------------------------------------------
 */
protected:
	virtual void	Idle_Logic(uint32 uTime);
	virtual void	Dead_Logic(uint32 uTime);
	virtual void	Combat_Logic(uint32 uTime);

	virtual void	Flee_Logic(uint32 uTime);
	virtual void	Patrol_Logic(uint32 uTime);
	virtual void	Gohome_Logic(uint32 uTime);
	virtual void	Service_Logic(uint32 uTime);
	virtual void	Approach_Logic(uint32 uTime);
	virtual void	TeamFollow_Logic(uint32 uTime);

/*
 -----------------------------------------------------------------------------------------------------------------------
 -----------------------------------------------------------------------------------------------------------------------
 */
protected:
	virtual void	Event_OnDie(Object *pKiller = NULL);
	virtual void	Event_OnDamage(int32 nDamage, Character *pAttacker);
	virtual void	Event_OnBeSpell(Character *pCharacter, int32 nGoodEffect);
	virtual void	Event_OnMove(const GLPos *pTar);

/*
 -----------------------------------------------------------------------------------------------------------------------
 -----------------------------------------------------------------------------------------------------------------------
 */
protected:
	void	ResetAllCombatInfo();
	BOOL	ScanEnemy(uint32 uTime);

/*
 -----------------------------------------------------------------------------------------------------------------------
 -----------------------------------------------------------------------------------------------------------------------
 */
protected:
	int32	m_EnemyCount;
	ObjID_t m_EnemyID[BHV_MAX_ENEMY_COUNT];

/*
 -----------------------------------------------------------------------------------------------------------------------
 -----------------------------------------------------------------------------------------------------------------------
 */
public:
	void	AddTeammate(ObjID_t TeammateID);
	void	DelAllTeammate(void);

	/*
	 ===============================================================================================================
	 ===============================================================================================================
	 */
	int32 GetTeammateCount(void) const
	{
		return m_TeammateCount;
	}

	/*
	 ===============================================================================================================
	 ===============================================================================================================
	 */
	BOOL HasTeammate(void)
	{
		return m_TeammateCount > 0 ? TRUE : FALSE;
	}

	void	SummonTeammate(int32 nX, int32 nZ, int32 count = 6);
	void	StartTeamFollow(BOOL bRespawn = FALSE);
	void	AddEnemyToTeammate(ObjID_t EnemyID);

/*
 -----------------------------------------------------------------------------------------------------------------------
 -----------------------------------------------------------------------------------------------------------------------
 */
protected:
	void	Teammate_Go_Fight(ObjID_t EnemyID);

/*
 -----------------------------------------------------------------------------------------------------------------------
 -----------------------------------------------------------------------------------------------------------------------
 */
private:
	int32	m_TeammateCount;
	ObjID_t m_TeammateID[BHV_MAX_TEAMMATE_COUNT];

/*
 -----------------------------------------------------------------------------------------------------------------------
 -----------------------------------------------------------------------------------------------------------------------
 */
public:

	/*
	 ===============================================================================================================
	 ===============================================================================================================
	 */
	void AddItem(ObjID_t ItemID)
	{
		m_ItemID = ItemID;
	}

	/*
	 ===============================================================================================================
	 ===============================================================================================================
	 */
	void DelItem(void)
	{
		m_ItemID = INVALID_ID;
	}

	/*
	 ===============================================================================================================
	 ===============================================================================================================
	 */
	BOOL HasItem(void)
	{
		return m_ItemID == INVALID_ID ? FALSE : TRUE;
	}

/*
 -----------------------------------------------------------------------------------------------------------------------
 -----------------------------------------------------------------------------------------------------------------------
 */
protected:
/*
 -----------------------------------------------------------------------------------------------------------------------
 -----------------------------------------------------------------------------------------------------------------------
 */
private:
	ObjID_t m_ItemID;

/*
 -----------------------------------------------------------------------------------------------------------------------
 -----------------------------------------------------------------------------------------------------------------------
 */
public:
	void	StartPatrol(BOOL bConvoyNPC = FALSE, BOOL bRespawn = FALSE);
	void	PausePatrol(void);
	void	StopPatrol(void);

	/*
	 ===============================================================================================================
	 ===============================================================================================================
	 */
	BOOL IsConvoyNPC(void) const
	{
		return m_bConvoyNPC;
	}

	GLPos	GetPosByIndexOfPassed(int32 nIndexOfPassed);

/*
 -----------------------------------------------------------------------------------------------------------------------
 -----------------------------------------------------------------------------------------------------------------------
 */
protected:
	BOOL		m_bContinuePatrol;
	BOOL		m_baHead;
	BOOL		m_bConvoyNPC;
	int32		m_nIndexOfPassed;
	int32		m_nIndexOfMoveTo;
	int32		m_nSettleTime;
	ScriptID_t	m_PatrolScriptID;

/*
 -----------------------------------------------------------------------------------------------------------------------
 -----------------------------------------------------------------------------------------------------------------------
 */
public:
	void	StartService(void);
	void	StopService(void);

/*
 -----------------------------------------------------------------------------------------------------------------------
 -----------------------------------------------------------------------------------------------------------------------
 */
protected:
/*
 -----------------------------------------------------------------------------------------------------------------------
 -----------------------------------------------------------------------------------------------------------------------
 */
private:
/*
 -----------------------------------------------------------------------------------------------------------------------
 -----------------------------------------------------------------------------------------------------------------------
 */
public:
	BOOL		ToBHVIdle(void);
	BOOL		ToBHVAttack(void);
	BOOL		ToBHVGoHome(void);
	BOOL		ToBHVRandMove(void);
	BOOL		ToBHVFlee(int32 type, float fX, float fZ);
	virtual BOOL	ToBHVApproachTar(void);
	OPT_RESULT		MonsterGo(const GLPos *pPos);

	/*
	 ===============================================================================================================
	 ===============================================================================================================
	 */
	void SetAttackPos(const GLPos &rPos)
	{
		m_ToAttackPos = rPos;
	}

	/*
	 ===============================================================================================================
	 ===============================================================================================================
	 */
	const GLPos &GetAttackPos(void) const
	{
		return m_ToAttackPos;
	}

/*
 -----------------------------------------------------------------------------------------------------------------------
 -----------------------------------------------------------------------------------------------------------------------
 */
public:
	ObjID_t		FindNearestTeammate(int32 nRadius);
protected:
	GLPos	FindNearestFriend();
	BOOL		GetBestPos(GLPos &Tar);
	BOOL		IsToGoHome(float &fMTDist, float &fETDist);
	GLPos	GetPosOfMemeberGo(const GLPos &rTargetPos, int32 index, float fDist);
	void		MemeberGo(const GLPos &rTargetPos, float fDist = 2.0f);
	void		MovePhonily(const GLPos &rTar);

	BOOL		IsJam(const GLPos &rTar);
	GLPos	GetRemovePos(const GLPos &rTar);
	void		CheckJamAndRemove();

/*
 -----------------------------------------------------------------------------------------------------------------------
 -----------------------------------------------------------------------------------------------------------------------
 */
private:
	int32	m_FleeType;
	int32	m_nMoveSpeed;
	BOOL	m_bCheckJam;

/*
 -----------------------------------------------------------------------------------------------------------------------
 -----------------------------------------------------------------------------------------------------------------------
 */
public:

	/*
	 ===============================================================================================================
	 ===============================================================================================================
	 */
	void SetSpellErrorCode(OPT_RESULT oResult)
	{
		m_SpellErrorCode = oResult;
	}

	/*
	 ===============================================================================================================
	 ===============================================================================================================
	 */
	OPT_RESULT GetSpellErrorCode(void) const
	{
		return m_SpellErrorCode;
	}

	/*
	 ===============================================================================================================
	 ===============================================================================================================
	 */
	void SetSpellID(int32 idSkill)
	{
		m_SpellID = idSkill;
	}

	/*
	 ===============================================================================================================
	 ===============================================================================================================
	 */
	int32 GetSpellID(void) const
	{
		return m_SpellID;
	}

	/*
	 ===============================================================================================================
	 ===============================================================================================================
	 */
	void SetNextSpellID(int32 idSkill)
	{
		m_NextSpellID = idSkill;
	}

	/*
	 ===============================================================================================================
	 ===============================================================================================================
	 */
	int32 GetNextSpellID(void) const
	{
		return m_NextSpellID;
	}

/*
 -----------------------------------------------------------------------------------------------------------------------
 -----------------------------------------------------------------------------------------------------------------------
 */
protected:
	ObjID_t m_SpellID;
	ObjID_t m_NextSpellID;
	ObjID_t m_SpellSenderID;
	OPT_RESULT m_SpellErrorCode;

/*
 -----------------------------------------------------------------------------------------------------------------------
 -----------------------------------------------------------------------------------------------------------------------
 */
public:
	void	PrintThreatList(Player *pPlayer);
	// [Todo][khan-2][2010-03-25][内容制作][head]制作3环副本――印度神庙3环
	BOOL	TestThreat(Player* pPlayer);

	void	RemoveAllThreat();
	void	RemoveCurrentThreat();
	void	RemoveThreatByObjID(ObjID_t objID);
	void	RemoveThreatByPtr(Character *pChar);

	BOOL	ModThreatByObjID(ObjID_t objID, int32 nMount = 1);
	BOOL	ModThreatByPtr(Character *pChar, int32 nMount = 1);

	/*
	 ===============================================================================================================
	 ===============================================================================================================
	 */
	Character *GetNextTarget()
	{
		return m_pNextTarget;
	}

	/*
	 ===============================================================================================================
	 ===============================================================================================================
	 */
	int32 GetThreatCount() const
	{
		return m_nThreatCount;
	}

	BOOL	RandomAttack(int32 nModThreat);
	BOOL	UseSpellToSpecialProfession(int32 nProfession, int32 nSkillID);
	BOOL	AttackSpecialProfession(int32 nProfession, int32 nModThreat);
	BOOL	IsStrickBackMonster();

	void* getThreat(uint32_t id);
	void  addThreat(uint32_t id, void* slot);
/*
 -----------------------------------------------------------------------------------------------------------------------
 -----------------------------------------------------------------------------------------------------------------------
 */
protected:
	int32		*GetFreeThreatSlot();
	Character	*GetMostHated();
	int32		CalcThreat(Character *pChar, int32 nSpellID, int32 nDmg);
	BOOL		IsNeedStrickBack(Character *pObj_Character, int32 nGoodEffect);

	void		SetNextTarget(Character *pChar);
	void		RemoveThreatByObjID_i(ObjID_t objID);
	void		RemoveThreatByPtr_i(Character *pChar);

	int32		m_nThreatCount;

	std::unordered_map<uint32_t, void*>	m_ThreatList;
	int32		m_nCurrentHighestThreat;
	Character	*m_pNextTarget;
	ObjID_t		m_NextTargetID;
	int32		m_aThreatList[MAX_THREAT_COUNT];

/*
 -----------------------------------------------------------------------------------------------------------------------
 -----------------------------------------------------------------------------------------------------------------------
 */
public:

	/*
	 ===============================================================================================================
	 ===============================================================================================================
	 */
	void SetBehavior_TemplateID(int32 value)
	{
		m_nAITemplte = value;
		if(!(m_nAITemplte >= 0 && m_nAITemplte < MAX_AITEMPLATES_COUNT))
			return;
		InitTimesFromBehavior_Template(m_nAITemplte);
	}

	void	InitTimesFromBehavior_Template(int32 nBehavior_Template);
	void	ChangeAITemplete(int32 nNewBehavior_Template);

/*
 -----------------------------------------------------------------------------------------------------------------------
 -----------------------------------------------------------------------------------------------------------------------
 */
protected:
	BOOL	ExcuteStateBehavior_Template(int32 state);
	BOOL	ExcuteEventBehavior_Template(int32 event);
	BOOL	CheckCondition(const AIRecord &record, int32 times);
	BOOL	DoOperator(const AIRecord &record, int32 state = -1, int32 event = -1);
	BOOL	ExcuteScriptOnEvent(int32 event);
	BOOL	ExcuteScriptInState(int32 state);

/*
 -----------------------------------------------------------------------------------------------------------------------
 -----------------------------------------------------------------------------------------------------------------------
 */
private:
	int32	m_nAITemplte;
	int32	m_aBehavior_TemplateTimes[MAX_AIRECORDS_COUNT];

/*
 -----------------------------------------------------------------------------------------------------------------------
 -----------------------------------------------------------------------------------------------------------------------
 */
public:
	enum E_COMMAND_TYPE
	{
		E_COMMAND_TYPE_INVALID	= -1,
		E_COMMAND_TYPE_TOIDLE,
		E_COMMAND_TYPE_TOFLEE,
		E_COMMAND_TYPE_TOATTACK,
		E_COMMAND_TYPE_NUM,
	};
	typedef struct _SBHVCommand
	{
		int32	commandType;
		int32	param[3];
		_SBHVCommand()
		{
			commandType = E_COMMAND_TYPE_INVALID;
			memset(param, INVALID_ID, sizeof(int32) * 3);
		}

		/*
		 =======================================================================================================
		 =======================================================================================================
		 */
		void Clear(void)
		{
			commandType = E_COMMAND_TYPE_INVALID;
			memset(param, INVALID_ID, sizeof(int32) * 3);
		}
	}
	SAICommand, *SAICommandPtr;

	int32 BHVParam(uint32 AIParam);

	/*
	 ===============================================================================================================
	 ===============================================================================================================
	 */
	int32 GetSingleDamage(void) const
	{
		return m_nDamage;
	}

	/*
	 ===============================================================================================================
	 ===============================================================================================================
	 */
	void SetLogicStop(BOOL bStop)
	{
		m_bLogicStop = bStop;
	}

	void	ProcessPaoPao(void);

	/*
	 ===============================================================================================================
	 ===============================================================================================================
	 */
	void PushCommand(const SAICommand &command)
	{
		m_SAICommand = command;
	}

	void	SetSpeedyOfRecover(float fSpeedyOfRecover = 1.0f);

	/*
	 ===============================================================================================================
	 ===============================================================================================================
	 */
	float GetSpeedyOfRecover(void) const
	{
		return m_fSpeedyOfRecover;
	}

/*
 -----------------------------------------------------------------------------------------------------------------------
 -----------------------------------------------------------------------------------------------------------------------
 */
protected:
	void	Update_RefusePaoPaoTime(void);
	void	RecoverHP(void);
	void	ExcuteCommand(void);

/*
 -----------------------------------------------------------------------------------------------------------------------
 -----------------------------------------------------------------------------------------------------------------------
 */
protected:
	CTinyTimer	m_ScanTimer;
	CTinyTimer	m_RandMoveTimer;
	CTinyTimer	m_BodyTimer;

	int32		m_nDamage;
	int32		m_nRefusePaoPaoTime;
	BOOL		m_bLogicStop;
	GLPos	m_ToAttackPos;
	float		m_fSpeedyOfRecover;
	uint32		m_uServiceTime;
	SAICommand	m_SAICommand;
};
#endif
