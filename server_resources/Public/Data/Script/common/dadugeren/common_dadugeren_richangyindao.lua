-- 
x270300_g_ScriptId 		            = 270300
x270300_g_MissionId                 = 4400

x270300_g_MissionName				= "【个人】每日新鲜事儿"
x270300_g_MissionTarget				= "  完成#G%s#W(%d/1)\n  完成#G%s#W#W(%d/1)\n  完成#G%s#W(%d/1)"          --任务目标
x270300_g_MissionInfo				= ""            --任务信息
x270300_g_ContinueInfo				= "\t怎么？你对付不了那些可恶的盗宝客么？看来我们要另外物色人选了。"  --任务继续信息
x270300_g_MissionCompleted			= "\t真没想到啊！你这么快就解决了那里的麻烦。拿好，这就是我们事先约定好的报酬。\n\t等你收集齐了#Y四张藏宝图碎片#W之后就可以在我这里将这些神秘的碎片重新拼合成为一张完整的藏宝图。"  --任务完成信息
x270300_g_MissionHelp				= "#G据说这些盗宝客身上也带有类似的藏宝图，在清缴他们的过程中，你也很有可能会获得藏宝图的一部分。#W"          --任务提示信息
x270300_g_MissionDescription        = "任务描述，完成三个今天的个人任务――#B%s#W，#B%s#W和#B%s#W。"
x270300_g_MissionTips               = "任务提示"
x270300_g_MissionBook               = "任务攻略"

--经验奖励
x270300_g_RewardXP                  = 10000

-- 全部玩法列表
x270300_g_GameTable     = {
                            { gameId = 1012, missionId = 9331, scriptId = 300575, name = "\n\t\t\t谍影重重\n任务简介\n\t威海港附近出现了东瀛间谍！捕头陈季初正为此事头疼。\n \n任务发布人\n\t陈季初 威海港（89，143）" },         -- 谍影重重
                            { gameId = 1014, missionId = 9333, scriptId = 300577, name = "\n\t\t\t东海海图\n任务简介\n\t威海港的大元水师即将东征，可是水师偏将那海却还没拿到重要的东海海图！\n \n任务发布人\n\t那海 威海港（103，97）" },         -- 东海海图
                            { gameId = 1015, missionId = 9334, scriptId = 300578, name = "\n\t\t\t黄道吉日\n任务简介\n\t威海港扬武号即将出海，身为船主的木图特尔却不知道出海日期！\n \n任务发布人\n\t木图特尔 威海港（90，101）" },         -- 黄道吉日
                            { gameId = 1013, missionId = 9332, scriptId = 300576, name = "\n\t\t\t倾城火雷\n任务简介\n\t威海港竟然埋有火雷！巡城官夏之章可有的忙了。\n \n任务发布人\n\t夏之章 威海港（97，91）" },         -- 倾城火雷
                            { gameId = 1005, missionId = 9310, scriptId = 300566, name = "\n\t\t\t生死财神\n任务简介\n\t一向节俭的大都盐帮堂主沈芊芊忽然阔绰的高价收购物品，好像与活财神沈万三有一些关系。\n \n任务发布人\n\t沈芊芊 大都（173，200）" },         -- 生死财神
                            { gameId = 1024, missionId = 9501, scriptId = 300581, name = "\n\t\t\t赵王府选美\n任务简介\n\t回纥美女来到了大都赵王府！没看赵王府采办铁算更加趾高气扬了。\n \n任务发布人\n\t铁算 大都（169，200）" },       -- 赵王府选妃
                            { gameId = 1004, missionId = 9302, scriptId = 300565, name = "\n\t\t\t相国寺比武\n任务简介\n\t众武林豪侠齐聚大都相国寺！应邀参加相国寺比武。\n \n任务发布人\n\t明空 大都（169，185）" },       -- 相国寺比武
                            { gameId = 1025, missionId = 9500, scriptId = 300580, name = "\n\t\t\t心诚则灵\n任务简介\n\t一向风平浪静的威海，今日来乌云遮日，狂风怒号！这可愁坏了抚远大将军范文虎。\n \n任务发布人\n\t范文虎 威海港（125，156）" },         -- 心诚则灵
                            { gameId = 1002, missionId = 9301, scriptId = 300563, name = "\n\t\t\t赵王府斗戏\n任务简介\n\t大都赵王府要开大戏了，连赵王府采办铁算都忙的不可开交。\n \n任务发布人\n\t铁算 大都（169，200）" },       -- 赵王府斗戏
                            { gameId = 1011, missionId = 9330, scriptId = 300573, name = "\n\t\t\t紫青宝剑\n任务简介\n\t名动天下的紫青侠女竟然来到大都为其紫青宝剑寻主。\n \n任务发布人\n\t紫云 大都（173，185）" },         -- 紫青宝剑
                            { gameId = 1001, missionId = 9300, scriptId = 300564, name = "\n\t\t\t四大法王\n任务简介\n\t中原武林举足轻重的明教内部竟然有叛徒！大都明教香主周颠提供的信息不会有错。\n \n任务发布人\n\t周颠 大都（164，185）" },         -- 四大法王
                            { gameId = 1010, missionId = 9325, scriptId = 300572, name = "\n\t\t\t大内密探\n任务简介\n\t大都卫帅府将军达鲁花手下能人无数，竟然识破了敌人企图潜入大都的阴谋。\n \n任务发布人\n\t达鲁花 大都（164，200）" },         -- 大内密探
}
-- 已经开放的玩法列表
x270300_g_OpenedTable   = {}

-- GLServer和MapServer握手后调用此函数
function x270300_ProcMapInit( sceneId)
    local qid = {}
    qid[1] = GetCountryParam( sceneId, 0, CD_RICHANG_QUESTID)
    qid[2] = GetCountryParam( sceneId, 1, CD_RICHANG_QUESTID)
    qid[3] = GetCountryParam( sceneId, 2, CD_RICHANG_QUESTID)
    if qid[1] <= 0 or qid[2] <= 0 or qid[3] <= 0 then
        x270300_ProcDayChanged( sceneId)
    else
        for i = 1, 3 do
            for j, item in x270300_g_GameTable do
                if qid[i] == item.gameId then
                    x270300_g_OpenedTable[ i] = item
                    SetGameOpenById( x270300_g_OpenedTable[ i].gameId, 1)
                    break
                end
            end
        end
    end
end

-- 日期切换，随机选择三个玩法开放
function x270300_ProcDayChanged( sceneId)
    -- 首先关闭今日开放的玩法
    if getn( x270300_g_OpenedTable) > 0 then
        SetGameOpenById( x270300_g_OpenedTable[ 1].gameId, 0)
        SetGameOpenById( x270300_g_OpenedTable[ 2].gameId, 0)
        SetGameOpenById( x270300_g_OpenedTable[ 3].gameId, 0)
    end

    -- 把今天未开放的玩法全部放入allGame
    local allGame = {}
    local nCount = 0
    for i, item in x270300_g_GameTable do
        if getn( x270300_g_OpenedTable) > 0 then
            if item.gameId ~= x270300_g_OpenedTable[ 1].gameId and item.gameId ~= x270300_g_OpenedTable[ 2].gameId and item.gameId ~= x270300_g_OpenedTable[ 3].gameId then
                nCount = nCount + 1
                allGame[ nCount] = item
            end
        else
            -- 如果今天没有开放玩法：x270300_g_OpenedTable为空
            nCount = nCount + 1
            allGame[ nCount] = item
        end
    end

    -- 随机选择3个玩法
    for i = 1, 3 do
        local index = random( 1, getn( allGame) )
        --print( "*-*-*-*-*-*-*", index)
        x270300_g_OpenedTable[ i] = allGame[ index]
        local temp = {}
        local nCount = 0
        for j, item in allGame do
            if j ~= index then
                nCount = nCount + 1
                temp[ nCount] = item
            end
        end
        allGame = temp
    end

    SetGameOpenById( x270300_g_OpenedTable[ 1].gameId, 1)
    SetGameOpenById( x270300_g_OpenedTable[ 2].gameId, 1)
    SetGameOpenById( x270300_g_OpenedTable[ 3].gameId, 1)

    SetCountryParam( sceneId, 0, CD_RICHANG_QUESTID, x270300_g_OpenedTable[ 1].gameId)
    SetCountryParam( sceneId, 1, CD_RICHANG_QUESTID, x270300_g_OpenedTable[ 2].gameId)
    SetCountryParam( sceneId, 2, CD_RICHANG_QUESTID, x270300_g_OpenedTable[ 3].gameId)
    -- print( x270300_g_OpenedTable[ 1].gameId, "*-*-*-*-*-*-*" )
    -- print( x270300_g_OpenedTable[ 2].gameId, "*-*-*-*-*-*-*" )
    -- print( x270300_g_OpenedTable[ 3].gameId, "*-*-*-*-*-*-*" )
    -- PrintNum( 0)
end

----------------------------------------------------------------------------------------------
--枚举
----------------------------------------------------------------------------------------------
function x270300_ProcEnumEvent( sceneId, selfId, NPCId, MissionId)
    --x270300_ProcDayChanged( sceneId)
    if getn( x270300_g_OpenedTable) == 0 then
        return
    end

    local state = GetQuestStateNM( sceneId, selfId, NPCId, x270300_g_MissionId)
    AddQuestNumText( sceneId, x270300_g_MissionId, x270300_g_MissionName, 3)
end

----------------------------------------------------------------------------------------------
--脚本默认事件
----------------------------------------------------------------------------------------------
function x270300_ProcEventEntry( sceneId ,selfId, NPCId, idScript, idExt)
    -- 显示今天开放的三个任务
	BeginQuestEvent( sceneId)
		--任务信息
		AddQuestText( sceneId, "#Y"..x270300_g_MissionName)
        if getn( x270300_g_OpenedTable) > 0 then
            AddQuestText( sceneId, format( "\t#Y@myname#W，你找我打听事情，可是找对人了，别说这大都附近的风吹草动躲不过我的眼睛，就算远在威海的大事小情我也了如指掌。\n\t来来来，附耳过来，老夫告诉你，今天各地都发生了什么值得关注的事儿:\n\t#B%s\n\t%s\n\t%s", 
            x270300_g_OpenedTable[ 1].name, x270300_g_OpenedTable[ 2].name, x270300_g_OpenedTable[ 3].name) )
        else
            AddQuestText( sceneId, "今天没有开放任何任务。" )
        end
	EndQuestEvent()
	DispatchQuestEventList( sceneId, selfId, NPCId)
	
	-- 给道具
	if GetItemCount(sceneId,selfId,12035020) <= 0 then   
		BeginAddItem( sceneId )
		AddItem( sceneId, 12035020, 1 )
		local ret = EndAddItem( sceneId, selfId )
		if ret > 0 then
			AddItemListToPlayer(sceneId,selfId)
			
			Msg2Player( sceneId, selfId, format("#Y获得#G1个#Y#{_ITEM%d}！", 12035020), 8, 3)
		else
			Msg2Player( sceneId, selfId, format("#Y背包空间不足，无法得到#Y#{_ITEM%d}！", 12035020), 8, 3)
		end                                          
	end
end

function x270300_ProcAcceptCheck( sceneId, selfId, NPCId)
    return 1
end

function x270300_DispatchCompletedInfo( sceneId, selfId, NPCId)
    -- 显示任务完成信息
	BeginQuestEvent( sceneId)
		--任务信息
		AddQuestText( sceneId, "#Y"..x270300_g_MissionName)
		AddQuestText( sceneId, "任务完成。" )

        AddQuestExpBonus( sceneId, x270300_g_RewardXP)
	EndQuestEvent()
	DispatchQuestContinueInfoNM( sceneId, selfId, NPCId, x270300_g_ScriptId, x270300_g_MissionId)
end

function x270300_ProcQuestSubmit( sceneId, selfId, NPCId, selectRadioId, MissionId)
    if IsHaveQuestNM( sceneId, selfId, x270300_g_MissionId) then
        DelQuest( sceneId, selfId, x270300_g_MissionId)
        AddExp( sceneId, selfId, x270300_g_RewardXP)
    end
end

function x270300_DispatchContinueInfo( sceneId, selfId, NPCId)
    -- 显示任务继续信息
	BeginQuestEvent( sceneId)
		--任务信息
		AddQuestText( sceneId, "#Y"..x270300_g_MissionName)
		AddQuestText( sceneId, "任务完成了么？" )

        AddQuestExpBonus( sceneId, x270300_g_RewardXP)
	EndQuestEvent()
	DispatchQuestEventList( sceneId, selfId, NPCId)
end

function x270300_ProcQuestAccept( sceneId, selfId, targetId, MissionId)
    if IsHaveQuestNM(sceneId, selfId, x270300_g_MissionId) > 0 then
        -- 
        DelQuest( sceneId, selfId, x270300_g_MissionId)
        AddExp( sceneId, selfId, x270300_g_RewardXP)
    else
        local result = AddQuest( sceneId, selfId, x270300_g_MissionId, x270300_g_ScriptId, 0, 0, 0, 0)
        if result == 0 then
            Msg2Player( sceneId, selfId, "任务已满，任务接受失败", 8, 3)
            return
        end

        -- 调试用
        -- local misIndex = GetQuestIndexByID( sceneId, selfId, x270300_g_MissionId)
        -- SetQuestByIndex( sceneId, selfId, misIndex, 0, 1)
        -- SetQuestByIndex( sceneId, selfId, misIndex, 7, 1)

        x270300_ProcQuestLogRefresh( sceneId, selfId, x270300_g_MissionId)
    end
end

function x270300_ProcQuestLogRefresh( sceneId, selfId, MissionId)
    local misIndex = GetQuestIndexByID( sceneId, selfId, x270300_g_MissionId)
    local mp1 = GetQuestParam( sceneId, selfId, misIndex, 1)
    local mp2 = GetQuestParam( sceneId, selfId, misIndex, 2)
    local mp3 = GetQuestParam( sceneId, selfId, misIndex, 3)
    local count = mp1 + mp2 + mp3

	BeginQuestEvent( sceneId)
        AddQuestLogCustomText( sceneId,
                                "",                             -- 标题
                                x270300_g_MissionName.."（"..count.."/3）",             -- 任务名字
                                format( x270300_g_MissionTarget, 
                                    x270300_g_OpenedTable[ 1].name, mp1, 
                                    x270300_g_OpenedTable[ 2].name, mp2, 
                                    x270300_g_OpenedTable[ 3].name, mp3), 
                                "",                             --任务NPC
                                x270300_g_MissionBook, 
                                format( x270300_g_MissionDescription, 
                                x270300_g_OpenedTable[ 1].name, x270300_g_OpenedTable[ 2].name, x270300_g_OpenedTable[ 3].name), 
                                x270300_g_MissionTips)
    AddQuestExpBonus( sceneId, 10000)
	EndQuestEvent()
	DispatchQuestLogUpdate( sceneId, selfId, x270300_g_MissionId)
end

-- 显示任务信息
function x270300_DispatchMissionInfo( sceneId, selfId, NPCId)
	local level = GetLevel( sceneId, selfId)

	BeginQuestEvent( sceneId)
		--任务信息
		AddQuestText( sceneId, "#Y"..x270300_g_MissionName)
		AddQuestText( sceneId, format( x270300_g_MissionDescription, 
            x270300_g_OpenedTable[ 1].name, x270300_g_OpenedTable[ 2].name, x270300_g_OpenedTable[ 3].name) )

        AddQuestExpBonus( sceneId, 10000)
	EndQuestEvent()
	DispatchQuestInfoNM( sceneId, selfId, NPCId, x270300_g_ScriptId, x270300_g_MissionId)
end

-- 完成一个子任务
function x270300_OnSubmissionFinished( sceneId, selfId, MissionId)
    local day = GetDayOfYear()
    if GetQuestData(sceneId, selfId, MD_RICHANG_DAY[1], MD_RICHANG_DAY[2],MD_RICHANG_DAY[3] ) == day then
        local count = GetQuestData( sceneId, selfId, MD_RICHANG_COUNT[1], MD_RICHANG_COUNT[2], MD_RICHANG_COUNT[3] )
        if count < 3 then
            SetQuestData( sceneId, selfId, MD_RICHANG_COUNT[1], MD_RICHANG_COUNT[2], MD_RICHANG_COUNT[3], 1 + count)
        else
            return 0
        end
    else
        SetQuestData( sceneId, selfId, MD_RICHANG_DAY[1], MD_RICHANG_DAY[2], MD_RICHANG_DAY[3], day)
        SetQuestData( sceneId, selfId, MD_RICHANG_COUNT[1], MD_RICHANG_COUNT[2], MD_RICHANG_COUNT[3], 1)
    end

    return 1
end

----------------------------------------------------------------------------------------------
--接受
----------------------------------------------------------------------------------------------
function x270300_ProcAccept( sceneId, selfId)
end

----------------------------------------------------------------------------------------------
--放弃
----------------------------------------------------------------------------------------------
function x270300_ProcQuestAbandon( sceneId, selfId, MissionId)
    if IsHaveQuestNM( sceneId, selfId, x270300_g_MissionId) == 1 then
        DelQuest( sceneId, selfId, x270300_g_MissionId)
    end
end

----------------------------------------------------------------------------------------------
--继续
----------------------------------------------------------------------------------------------
function x270300_OnContinue( sceneId, selfId, targetId)
end

----------------------------------------------------------------------------------------------
--杀死怪物或玩家
----------------------------------------------------------------------------------------------
function x270300_ProcQuestObjectKilled( sceneId, selfId, objdataId, objId, MissionId)
end

----------------------------------------------------------------------------------------------
--进入区域事件
----------------------------------------------------------------------------------------------
function x270300_ProcAreaEntered( sceneId, selfId, zoneId, MissionId)
end

----------------------------------------------------------------------------------------------
--道具改变
----------------------------------------------------------------------------------------------
function x270300_ProcQuestItemChanged( sceneId, selfId, itemdataId, MissionId)
end

----------------------------------------------------------------------------------------------
function x270300_ItemProcEventEntry( sceneId, selfId, BagIndex )

	local gameId1 = GetCountryParam( sceneId, 0, CD_RICHANG_QUESTID)
	local gameId2 = GetCountryParam( sceneId, 1, CD_RICHANG_QUESTID)
	local gameId3 = GetCountryParam( sceneId, 2, CD_RICHANG_QUESTID)
	local name1, name2, name3
	
	for i, item in x270300_g_GameTable do
		if gameId1 == item.gameId then
			name1 = item.name
		end
		if gameId2 == item.gameId then
			name2 = item.name
		end
		if gameId3 == item.gameId then
			name3 = item.name
		end
	end
	
	-- 显示今天开放的三个任务
	BeginQuestEvent( sceneId)
		--任务信息
		AddQuestText( sceneId, "#Y"..x270300_g_MissionName)
		
		if name1 ~= nil and name2 ~= nil and name3 ~= nil then
			AddQuestText( sceneId, format( "\t官人商人武林人，人人留意。\n\t家事国事天下事，事事关心。\n\t据我包打听所知，今天会有如下几件大事发生：\n#B%s\n \n \n%s\n \n \n%s", 
            name1, name2, name3 ) )
		else
			AddQuestText( sceneId, "今天没有开放任何任务。" )
		end 
	EndQuestEvent()
    DispatchQuestInfo(sceneId, selfId, selfId, x270300_g_ScriptId, -1)
end