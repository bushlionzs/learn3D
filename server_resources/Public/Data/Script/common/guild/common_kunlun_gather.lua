--MisDescBegin
x300904_g_ScriptId		=	300904
x300904_g_LevelLess		= 	40 
x300904_g_NPCName		= "@npc_129020"
--MisDescEnd
x300904_g_BonusMoney8	=   50
--x300904_g_GuildExpBonus =	1
x300904_g_Mis_Count		= 1

x300904_g_SubMissionId  ={
						 {MissionId = 7698, MissionName = "【帮会】帮会图腾",MissionTarget ="　前往相应等级@npc_31123收集#G灰色图腾#W",MissionInfo ="\t帮会的图腾，代表着帮会的信仰，同时也是每个帮会的标志。#r\t在自己等级不高于怪物等级5级以上的#G领地地图#W找到古老的图腾并收集到#G5个灰色图腾#W回来交给我。那里充斥着重重危险，您愿意去那里考验自己的能力吗？#r\t当帮主发布#G图腾令#W时2小时内回复任务可获得翻倍奖励（经验，帮贡）和2点使命点！" ,MissionHelp ="注意，您的等级不能高于怪物等级5级以上，否则将不能完成任务。随着你所在帮会等级的提高，你获得的奖励也会相应增加。" ,Completed ="我需要的灰色图腾，你已经找到了？太感谢了，辛苦了，这是给你的酬谢。" ,Missionruse ="\t你可通过#G边塞#W的#G领地传送人#W前往领地，可通过#G场景地图（快捷键M）#W找到#G古老的图腾#W！#r\t#R如果您的等级高于该场景怪物等级5级以上，将无法收集成功！" ,level = 60,itmID =13011005,SubmitNPCGUID	=129020,NpcName = "@npc_129020"},
						 {MissionId = 7699, MissionName = "【帮会】帮会图腾",MissionTarget ="　前往相应等级@npc_31123收集#G褐色图腾#W",MissionInfo ="\t帮会的图腾，代表着帮会的信仰，同时也是每个帮会的标志。#r\t在自己等级不高于怪物等级5级以上的#G领地地图#W找到古老的图腾并收集到#G5个褐色图腾#W回来交给我。那里充斥着重重危险，您愿意去那里考验自己的能力吗？#r\t当帮主发布#G图腾令#W时2小时内回复任务可获得翻倍奖励（经验，帮贡）和2点使命点！" ,MissionHelp ="注意，您的等级不能高于怪物等级5级以上，否则将不能完成任务。随着你所在帮会等级的提高，你获得的奖励也会相应增加。" ,Completed ="我需要的褐色图腾，你已经找到了？太感谢了，辛苦了，这是给你的酬谢。" ,Missionruse ="\t你可通过#G边塞#W的#G领地传送人#W前往领地，可通过#G场景地图（快捷键M）#W找到#G古老的图腾#W！#r\t#R如果您的等级高于该场景怪物等级5级以上，将无法收集成功！" ,level = 75,itmID =13011602,SubmitNPCGUID	=129020,NpcName = "@npc_129020"},
						 {MissionId = 7700, MissionName = "【帮会】帮会图腾",MissionTarget ="　前往相应等级@npc_31123收集#G橙色图腾#W",MissionInfo ="\t帮会的图腾，代表着帮会的信仰，同时也是每个帮会的标志。#r\t在自己等级不高于怪物等级5级以上的#G领地地图#W找到古老的图腾并收集到#G5个橙色图腾#W回来交给我。那里充斥着重重危险，您愿意去那里考验自己的能力吗？#r\t当帮主发布#G图腾令#W时2小时内回复任务可获得翻倍奖励（经验，帮贡）和2点使命点！" ,MissionHelp ="注意，您的等级不能高于怪物等级5级以上，否则将不能完成任务。随着你所在帮会等级的提高，你获得的奖励也会相应增加。" ,Completed ="我需要的橙色图腾，你已经找到了？太感谢了，辛苦了，这是给你的酬谢。" ,Missionruse ="\t你可通过#G边塞#W的#G领地传送人#W前往领地，可通过#G场景地图（快捷键M）#W找到#G古老的图腾#W！#r\t#R如果您的等级高于该场景怪物等级5级以上，将无法收集成功！" ,level = 85,itmID =13011604,SubmitNPCGUID	=129020,NpcName = "@npc_129020"},
						 {MissionId = 7750, MissionName = "【帮会】帮会图腾",MissionTarget ="　前往相应等级@npc_31123收集#G青色图腾#W",MissionInfo ="\t帮会的图腾，代表着帮会的信仰，同时也是每个帮会的标志。#r\t在自己等级不高于怪物等级5级以上的#G领地地图#W找到古老的图腾并收集到#G5个青色图腾#W回来交给我。那里充斥着重重危险，您愿意去那里考验自己的能力吗？#r\t当帮主发布#G图腾令#W时2小时内回复任务可获得翻倍奖励（经验，帮贡）和2点使命点！" ,MissionHelp ="注意，您的等级不能高于怪物等级5级以上，否则将不能完成任务。随着你所在帮会等级的提高，你获得的奖励也会相应增加。" ,Completed ="我需要的青色图腾，你已经找到了？太感谢了，辛苦了，这是给你的酬谢。" ,Missionruse ="\t你可通过#G边塞#W的#G领地传送人#W前往领地，可通过#G场景地图（快捷键M）#W找到#G古老的图腾#W！#r\t#R如果您的等级高于该场景怪物等级5级以上，将无法收集成功！" ,level = 95,itmID =13011605,SubmitNPCGUID	=129020,NpcName = "@npc_129020"},
						 {MissionId = 7751, MissionName = "【帮会】帮会图腾",MissionTarget ="　前往相应等级@npc_31123收集#G绿色图腾#W",MissionInfo ="\t帮会的图腾，代表着帮会的信仰，同时也是每个帮会的标志。#r\t在自己等级不高于怪物等级5级以上的#G领地地图#W找到古老的图腾并收集到#G5个绿色图腾#W回来交给我。那里充斥着重重危险，您愿意去那里考验自己的能力吗？#r\t当帮主发布#G图腾令#W时2小时内回复任务可获得翻倍奖励（经验，帮贡）和2点使命点！" ,MissionHelp ="注意，您的等级不能高于怪物等级5级以上，否则将不能完成任务。随着你所在帮会等级的提高，你获得的奖励也会相应增加。" ,Completed ="我需要的绿色图腾，你已经找到了？太感谢了，辛苦了，这是给你的酬谢。" ,Missionruse ="\t你可通过#G边塞#W的#G领地传送人#W前往领地，可通过#G场景地图（快捷键M）#W找到#G古老的图腾#W！#r\t#R如果您的等级高于该场景怪物等级5级以上，将无法收集成功！" ,level = 105,itmID =13011606,SubmitNPCGUID=129020,NpcName = "@npc_129020"},						
						 {MissionId = 7782, MissionName = "【帮会】帮会图腾",MissionTarget ="　前往相应等级@npc_31123收集#G蓝色图腾#W",MissionInfo ="\t帮会的图腾，代表着帮会的信仰，同时也是每个帮会的标志。#r\t在自己等级不高于怪物等级5级以上的#G领地地图#W找到古老的图腾并收集到#G5个蓝色图腾#W回来交给我。那里充斥着重重危险，您愿意去那里考验自己的能力吗？#r\t当帮主发布#G图腾令#W时2小时内回复任务可获得翻倍奖励（经验，帮贡）和2点使命点！" ,MissionHelp ="注意，您的等级不能高于怪物等级5级以上，否则将不能完成任务。随着你所在帮会等级的提高，你获得的奖励也会相应增加。" ,Completed ="我需要的蓝色图腾，你已经找到了？太感谢了，辛苦了，这是给你的酬谢。" ,Missionruse ="\t你可通过#G边塞#W的#G领地传送人#W前往领地，可通过#G场景地图（快捷键M）#W找到#G古老的图腾#W！#r\t#R如果您的等级高于该场景怪物等级5级以上，将无法收集成功！"  ,level = 115,itmID =13011607,SubmitNPCGUID=129020,NpcName = "@npc_129020"},
						 }		
function x300904_ProcEnumEvent( sceneId, selfId, targetId, MissionId )
	if GetGuildID( sceneId, selfId ) == -1 then
 		--不在帮会中
		return
	end
	local level = GetLevel(sceneId,selfId)
	if level <40 then
		return
	end
	
	for i,itm in x300904_g_SubMissionId do
		if IsHaveQuestNM( sceneId, selfId, itm.MissionId ) > 0 then	-- 如果有这个任务
			return 0
		end
		if GetLevel(sceneId,selfId) <= itm.level then
			local state = GetQuestStateNM( sceneId, selfId, targetId, MissionId);
			--AddQuestTextNM( sceneId, selfId,itm.MissionName, MissionId, 8, state ,-1) -- 显示任务信息
			AddQuestNumText( sceneId, MissionId,itm.MissionName,8, state,-1);
			break
		end
	end
end

function x300904_ProcEventEntry( sceneId, selfId, targetId, MissionId )
	local missionDesc = x300904_GetMissionDesc(sceneId, selfId)
	if missionDesc ~= nil then
		if IsHaveQuestNM( sceneId, selfId, missionDesc.MissionId ) > 0 then
			local misIndex = GetQuestIndexByID(sceneId, selfId, missionDesc.MissionId);
			if(GetQuestParam(sceneId, selfId, misIndex, 7) == 1) then
				x300904_DispatchCompletedInfo( sceneId, selfId, targetId) --完成任务显示
			else
				x300904_DispatchContinueInfo( sceneId, selfId, targetId	) --未完成任务显示
			end
		end
		return
	end
	for i,itm in x300904_g_SubMissionId do
		if 	GetLevel(sceneId,selfId) <= itm.level then
			x300904_DispatchMissionInfo( sceneId, selfId, targetId, itm.MissionId )
			return
		end
		
	end
	
end

function x300904_CheckSubmit(sceneId, selfId,index)
	for i,itm in x300904_g_SubMissionId do
	local misIndex = GetQuestIndexByID(sceneId, selfId, itm.MissionId);
	return GetQuestParam(sceneId, selfId, misIndex, 7);
	end
end

function x300904_DispatchCompletedInfo( sceneId, selfId, targetId,index )
	local missionDesc = x300904_GetMissionDesc(sceneId, selfId)
	BeginQuestEvent(sceneId)
	AddQuestText(sceneId,"#Y"..missionDesc.MissionName)
	AddQuestText(sceneId,missionDesc.Completed)
	AddQuestText(sceneId," ")
	
	--1、经验
		local level = GetLevel(sceneId, selfId)
		local ExpBonus = ceil ( (100 * 3 * level * 20*1*1 ) )
		ExpBonus =floor(ExpBonus+0.5)
		if ExpBonus> 0 then
			AddQuestExpBonus(sceneId, ExpBonus )
		end
		--2 帮供
		if x300904_g_BonusMoney8>0 then
			AddQuestMoneyBonus8(sceneId,x300904_g_BonusMoney8)
		end
		--3 帮会经验
		-- if x300904_g_GuildExpBonus>0 then
			-- AddQuestGuildExpBonus(sceneId,x300904_g_GuildExpBonus)
		-- end
		EndQuestEvent(sceneId)
		DispatchQuestContinueInfoNM(sceneId, selfId, targetId, x300904_g_ScriptId, missionDesc.MissionId);
end

function x300904_DispatchContinueInfo( sceneId, selfId, targetId,index )
	
	local missionDesc = x300904_GetMissionDesc(sceneId, selfId)
	BeginQuestEvent(sceneId)

		--任务继续信息
		AddQuestText(sceneId,"#Y"..missionDesc.MissionName)
		AddQuestText(sceneId,format("%s", missionDesc.MissionInfo))
		AddQuestText(sceneId," ")

		--任务目标
		AddQuestText( sceneId,"#Y完成情况：")
		AddQuestText(sceneId, "未完成");

		--1、经验
		local level = GetLevel(sceneId, selfId)
		local ExpBonus = ceil ( (100 * 3 * level * 20*1*1 ) )
		ExpBonus =floor(ExpBonus+0.5)
		if ExpBonus> 0 then
			AddQuestExpBonus(sceneId, ExpBonus )
		end
		
		--2 经验
		if x300904_g_BonusMoney8>0 then
			AddQuestMoneyBonus8(sceneId,x300904_g_BonusMoney8)
		end
		--3 帮会经验
		-- if x300904_g_GuildExpBonus>0 then
			-- AddQuestGuildExpBonus(sceneId,x300904_g_GuildExpBonus)
		-- end

		
	--任务提示信息
		EndQuestEvent()
		DispatchQuestDemandInfo(sceneId, selfId, targetId, x300904_g_ScriptId, missionDesc.MissionId,0);

end

---------------------------------------------------------------------------------------------------
--向客户端发送任务信息
---------------------------------------------------------------------------------------------------
function x300904_DispatchMissionInfo( sceneId, selfId, NPCId,index )
		local missionDesc
		for i,itm in x300904_g_SubMissionId do
			if 	GetLevel(sceneId,selfId) <= itm.level then
				missionDesc = itm
				break
			end
		end
		
		BeginQuestEvent(sceneId)

		--任务信息
		local BangExp =x300904_g_BangExp
		AddQuestText(sceneId,"#Y"..missionDesc.MissionName)
		AddQuestText(sceneId,format("%s", missionDesc.MissionInfo))
		AddQuestText(sceneId," ")

		--任务目标
		AddQuestText( sceneId,"#Y任务目标：")
		AddQuestText( sceneId,format("%s", missionDesc.MissionTarget))
		AddQuestText( sceneId," ")

		--提示信息
		if missionDesc.MissionHelp ~= "" then

			AddQuestText(sceneId,"#Y任务提示：")
			AddQuestText(sceneId,format("%s", missionDesc.MissionHelp))
			AddQuestText(sceneId," ")
		end

		--任务奖励信息

		--1、经验
		local level = GetLevel(sceneId, selfId)
		local ExpBonus = ceil ( (100 * 3 * level * 20*1*1 ) )
		ExpBonus =floor(ExpBonus+0.5)
		if ExpBonus > 0 then
			AddQuestExpBonus(sceneId, ExpBonus )
		end
		
		--2 帮供
		if x300904_g_BonusMoney8>0 then
			AddQuestMoneyBonus8(sceneId,x300904_g_BonusMoney8)
		end
		--3 帮会经验
		-- if x300904_g_GuildExpBonus>0 then
			-- AddQuestGuildExpBonus(sceneId,x300904_g_GuildExpBonus)
		-- end
		EndQuestEvent(sceneId)
		DispatchQuestInfoNM(sceneId, selfId, NPCId, x300904_g_ScriptId, missionDesc.MissionId);
		
end

---------------------------------------------------------------------------------------------------
--获得奖励
---------------------------------------------------------------------------------------------------
function x300904_OnReturn1(sceneId, selfId,MissionData,MissionId,SubMissionId)
 
	local curTime = GetCurrentTime()
	local isMultiple = 0
	if curTime - MissionData < 2*60*60 then
		isMultiple = 1
	end
	x300904_GetBonus( sceneId,selfId, isMultiple,SubMissionId )
end

function x300904_GetBonus( sceneId, selfId, isMultiple,SubMissionId )

	--奖励经验
	local level = GetLevel(sceneId, selfId)
	--local gongdezhi =GetMeritInfo_Multiple(sceneId, selfId)
	local ExpBonus = ceil (100 * 3 * level * 20*1*1 )
	ExpBonus =floor(ExpBonus+0.5)
	local GuildLevel = GetGuildSimpleData(GetGuildID( sceneId, selfId ))--得到帮会简单数据(等级) 
    if ExpBonus > 0 then
    		local MissionName = "111"
    		for i,itm in x300904_g_SubMissionId do
				if SubMissionId == itm.MissionId then
				    MissionName = itm.MissionName
					break
				end
			end
			local text1 = "你完成了任务：".. MissionName;
    	   	local text2 = "获得#R经验"..ExpBonus.."点#o的奖励"
			--local text3 = "获得#R帮会功德1点#o的奖励"
			AddExp(sceneId, selfId, ExpBonus);
			--AddGuildMerit(sceneId, selfId,1)
			BeginQuestEvent(sceneId)
			AddQuestText(sceneId, text1);
			EndQuestEvent(sceneId)
			DispatchQuestTips(sceneId,selfId)	
			BeginQuestEvent(sceneId)
			AddQuestText(sceneId, text2);
			EndQuestEvent(sceneId)
			DispatchQuestTips(sceneId,selfId)
			-- BeginQuestEvent(sceneId)
			-- AddQuestText(sceneId, text3);
			-- EndQuestEvent(sceneId)
			-- DispatchQuestTips(sceneId,selfId)	
	  		Msg2Player(sceneId,selfId,text1,8,2)
	  		Msg2Player(sceneId,selfId,text2,8,2)
			--Msg2Player(sceneId,selfId,text3,8,2)
		if isMultiple == 1 then
			local ExpBonus1 = ceil (100 * 3 * level * 20*1*1 *3)
			local Exp3 = ceil (100 * 3 * level * 20*1*1*3 )
			local ExpBonus2 = ceil (100 * 3 * level * 20*1*1 *2)
			local pos = GetGuildOfficial(sceneId, selfId)
			local text3 = "获得#R使命点2点#o的奖励"
			AddGuildShiMing(sceneId, selfId,2)
			BeginQuestEvent(sceneId)
			AddQuestText(sceneId, text3);
			EndQuestEvent(sceneId)
			DispatchQuestTips(sceneId,selfId)	
	  		Msg2Player(sceneId,selfId,text3,8,2)
			if pos == 5 then
				local guildid =GetGuildID(sceneId, selfId)
				if  GetGuildCacheFreeParam(guildid,GD_GUILD_INDEX_CHIEF_MULTIMISSION_DAY) == GetDayOfYear() then
					BeginQuestEvent(sceneId)
					AddQuestText(sceneId, "帮主职位只能领取一次图腾令奖励");
					EndQuestEvent(sceneId)
					DispatchQuestTips(sceneId,selfId)
					Msg2Player(sceneId,selfId,"帮主职位只能领取一次图腾令奖励",8,2)
				else
					AddExp(sceneId, selfId, ExpBonus1);	
					BeginQuestEvent(sceneId)
					AddQuestText(sceneId, "额外获得#R经验"..Exp3.."点#o的奖励");
					EndQuestEvent(sceneId)
					DispatchQuestTips(sceneId,selfId)	
					Msg2Player(sceneId,selfId,"帮会多倍任务额外获得#R经验"..Exp3.."点#o的奖励",8,2)
					SetGuildQuestData(sceneId,GetGuildID(sceneId,selfId),GD_GUILD_INDEX_CHIEF_MULTIMISSION_DAY,GetDayOfYear(),0)
				end
			elseif pos == 4 then
				local guildid =GetGuildID(sceneId, selfId)
				if  GetGuildCacheFreeParam(guildid,GD_GUILD_INDEX_ASSCHIEF_MULTIMISSION_DAY) == GetDayOfYear() then
					BeginQuestEvent(sceneId)
					AddQuestText(sceneId, "副帮主职位只能领取一次图腾令奖励");
					EndQuestEvent(sceneId)
					DispatchQuestTips(sceneId,selfId)
					Msg2Player(sceneId,selfId,"副帮主职位只能领取一次图腾令奖励",8,2)
				else
					AddExp(sceneId, selfId, ExpBonus2);	
					BeginQuestEvent(sceneId)
					AddQuestText(sceneId, "额外获得#R经验"..ExpBonus2.."点#o的奖励");
					EndQuestEvent(sceneId)
					DispatchQuestTips(sceneId,selfId)	
					Msg2Player(sceneId,selfId,"帮会多倍任务额外获得#R经验"..ExpBonus2.."点#o的奖励",8,2)
					SetGuildQuestData(sceneId,GetGuildID(sceneId,selfId),GD_GUILD_INDEX_ASSCHIEF_MULTIMISSION_DAY,GetDayOfYear(),0)
				end
			else
				AddExp(sceneId, selfId, ExpBonus);	
				BeginQuestEvent(sceneId)
				AddQuestText(sceneId, "额外获得#R经验"..ExpBonus.."点#o的奖励");
				EndQuestEvent(sceneId)
				DispatchQuestTips(sceneId,selfId)	
				Msg2Player(sceneId,selfId,"帮会多倍任务额外获得#R经验"..ExpBonus.."点#o的奖励",8,2)
			end
		end
		if 	GuildLevel == 2 then
			local level = GetLevel(sceneId, selfId)
			local exp = ceil (100 * 3 * level * 20*0.25*1 )
			AddExp(sceneId, selfId, exp);	
			BeginQuestEvent(sceneId)
			AddQuestText(sceneId, "额外获得#R经验"..exp.."点#o的奖励");
			EndQuestEvent(sceneId)
			DispatchQuestTips(sceneId,selfId)	
			Msg2Player(sceneId,selfId,"帮会等级2级额外获得#R经验"..exp.."点#o的奖励",8,2)
		end
		if 	GuildLevel == 3 then
			local level = GetLevel(sceneId, selfId)
			local exp = ceil (100 * 3 * level * 20*0.5*1 )
			AddExp(sceneId, selfId, exp);	
			BeginQuestEvent(sceneId)
			AddQuestText(sceneId, "额外获得#R经验"..exp.."点#o的奖励");
			EndQuestEvent(sceneId)
			DispatchQuestTips(sceneId,selfId)	
			Msg2Player(sceneId,selfId,"帮会等级3级额外获得#R经验"..exp.."点#o的奖励",8,2)
		end
		if 	GuildLevel == 4 then
			local level = GetLevel(sceneId, selfId)
			local exp = ceil (100 * 3 * level * 20*0.75*1 )
			AddExp(sceneId, selfId, exp);	
			BeginQuestEvent(sceneId)
			AddQuestText(sceneId, "额外获得#R经验"..exp.."点#o的奖励");
			EndQuestEvent(sceneId)
			DispatchQuestTips(sceneId,selfId)	
			Msg2Player(sceneId,selfId,"帮会等级4级额外获得#R经验"..exp.."点#o的奖励",8,2)
		end
		if 	GuildLevel == 5 then
			local level = GetLevel(sceneId, selfId)
			local exp = ceil (100 * 3 * level * 20*1*1 )
			AddExp(sceneId, selfId, exp);	
			BeginQuestEvent(sceneId)
			AddQuestText(sceneId, "额外获得#R经验"..exp.."点#o的奖励");
			EndQuestEvent(sceneId)
			DispatchQuestTips(sceneId,selfId)	
			Msg2Player(sceneId,selfId,"帮会等级5级额外获得#R经验"..exp.."点#o的奖励",8,2)
		end
		if 	GuildLevel == 6 then
			local level = GetLevel(sceneId, selfId)
			local exp = ceil (100 * 3 * level * 20*1.25*1 )
			AddExp(sceneId, selfId, exp);	
			BeginQuestEvent(sceneId)
			AddQuestText(sceneId, "额外获得#R经验"..exp.."点#o的奖励");
			EndQuestEvent(sceneId)
			DispatchQuestTips(sceneId,selfId)	
			Msg2Player(sceneId,selfId,"帮会等级6级额外获得#R经验"..exp.."点#o的奖励",8,2)
		end
		if 	GuildLevel == 7 then
			local level = GetLevel(sceneId, selfId)
			local exp = ceil (100 * 3 * level * 20*1.5*1 )
			AddExp(sceneId, selfId, exp);	
			BeginQuestEvent(sceneId)
			AddQuestText(sceneId, "额外获得#R经验"..exp.."点#o的奖励");
			EndQuestEvent(sceneId)
			DispatchQuestTips(sceneId,selfId)	
			Msg2Player(sceneId,selfId,"帮会等级7级额外获得#R经验"..exp.."点#o的奖励",8,2)
		end
	end
--奖励帮贡
    if x300904_g_BonusMoney8 > 0 then
		AddGuildUserPoint(sceneId,selfId,x300904_g_BonusMoney8)	--增加帮贡
		local BonusMoney8 = x300904_g_BonusMoney8
		BeginQuestEvent(sceneId)
		AddQuestText(sceneId, "获得#R帮贡"..BonusMoney8.."点#o的奖励");
		EndQuestEvent(sceneId)
		DispatchQuestTips(sceneId,selfId)	
		Msg2Player(sceneId,selfId,format("获得#R帮贡"..BonusMoney8.."点#o的奖励", x300904_g_BonusMoney8),8,2)
			if isMultiple == 1 then
			local pos = GetGuildOfficial(sceneId, selfId)
				if pos == 5 then
					local guildid =GetGuildID(sceneId, selfId)
					if  GetGuildCacheFreeParam(guildid,GD_GUILD_INDEX_CHIEF_MULTIMISSION_DAY) == GetDayOfYear() then
						BeginQuestEvent(sceneId)
						AddQuestText(sceneId, "帮主职位只能领取一次图腾令奖励");
						EndQuestEvent(sceneId)
						DispatchQuestTips(sceneId,selfId)
						Msg2Player(sceneId,selfId,"帮主职位只能领取一次图腾令奖励",8,2)
					else
						AddGuildUserPoint(sceneId,selfId,150)	--增加帮贡
						local BonusMoney8 = x300904_g_BonusMoney8
						BeginQuestEvent(sceneId)
						AddQuestText(sceneId, "额外获得#R帮贡150点#o的奖励");
						EndQuestEvent(sceneId)
						DispatchQuestTips(sceneId,selfId)	
						Msg2Player(sceneId,selfId,"帮会多倍任务额外获得#R帮贡150点#o的奖励",8,2)
						SetGuildQuestData(sceneId,GetGuildID(sceneId,selfId),GD_GUILD_INDEX_CHIEF_MULTIMISSION_DAY,GetDayOfYear(),0)
					end
				elseif pos == 4 then
					local guildid =GetGuildID(sceneId, selfId)
					if  GetGuildCacheFreeParam(guildid,GD_GUILD_INDEX_ASSCHIEF_MULTIMISSION_DAY) == GetDayOfYear() then
						BeginQuestEvent(sceneId)
						AddQuestText(sceneId, "副帮主职位只能领取一次图腾令奖励");
						EndQuestEvent(sceneId)
						DispatchQuestTips(sceneId,selfId)
						Msg2Player(sceneId,selfId,"副帮主职位只能领取一次图腾令奖励",8,2)
					else
						AddGuildUserPoint(sceneId,selfId,100)	--增加帮贡
						local BonusMoney8 = x300904_g_BonusMoney8
						BeginQuestEvent(sceneId)
						AddQuestText(sceneId, "额外获得#R帮贡100点#o的奖励");
						EndQuestEvent(sceneId)
						DispatchQuestTips(sceneId,selfId)	
						Msg2Player(sceneId,selfId,"帮会多倍任务额外获得#R帮贡100点#o的奖励",8,2)
						SetGuildQuestData(sceneId,GetGuildID(sceneId,selfId),GD_GUILD_INDEX_ASSCHIEF_MULTIMISSION_DAY,GetDayOfYear(),0)
					end
				else
					AddGuildUserPoint(sceneId,selfId,50)	--增加帮贡
					local BonusMoney8 = x300904_g_BonusMoney8
					BeginQuestEvent(sceneId)
					AddQuestText(sceneId, "额外获得#R帮贡"..BonusMoney8.."点#o的奖励");
					EndQuestEvent(sceneId)
					DispatchQuestTips(sceneId,selfId)	
					Msg2Player(sceneId,selfId,format("帮会多倍任务额外获得#R帮贡"..BonusMoney8.."点#o的奖励", x300904_g_BonusMoney8),8,2)
				end
			end
	end
end

--**********************************
--接受
--**********************************
function x300904_ProcQuestAccept( sceneId, selfId, targetId, MissionId )

	if IsQuestFullNM( sceneId, selfId )==1 then
		BeginQuestEvent(sceneId)
		AddQuestText(sceneId,"可接任务数量已满")
		EndQuestEvent(sceneId)
		DispatchQuestTips(sceneId,selfId)
		return 
	end

	if GetGuildID( sceneId, selfId ) == -1 then
		--不在帮会中
		BeginQuestEvent(sceneId)
		AddQuestText(sceneId, "你不是帮会成员，请先加入帮会再来领取！");
		EndQuestEvent(sceneId)
		DispatchQuestTips(sceneId,selfId)	
		Msg2Player(sceneId,selfId,"你不是帮会成员，请先加入帮会再来领取！",8,2)
		return
	end
	
	local guildid = GetGuildID( sceneId, selfId )
	local GuildLevel = GetGuildSimpleData(guildid)--得到帮会简单数据(等级)
	if 	GuildLevel < 1 then
		BeginQuestEvent(sceneId)
		AddQuestText(sceneId, "很抱歉，帮会等级到达3级才可以接取该任务！");
		EndQuestEvent(sceneId)
		DispatchQuestTips(sceneId,selfId)	
		Msg2Player(sceneId,selfId,"很抱歉，帮会等级到达3级才可以接取该任务！",8,2)
	return 
	end
	
	if x300904_GetDayCount(sceneId, selfId) >= x300904_g_Mis_Count then
		BeginQuestEvent(sceneId)
		AddQuestText(sceneId, "你今天已经领取过该任务了，请明天再来吧！");
		EndQuestEvent(sceneId)
		DispatchQuestTips(sceneId,selfId)
		local Readme = "你今天已经领取过该任务了，请明天再来吧！"
		Msg2Player(sceneId,selfId,Readme,8,2)
		return
	end


	--检查前置任务
	local FrontMissiontId1, FrontMissiontId2, FrontMissiontId3 = GetFrontQuestIdNM( sceneId, selfId, MissionId )
	if FrontMissiontId1 ~= -1 then
		if IsQuestHaveDoneNM( sceneId, selfId, FrontMissiontId1 ) == 0 then
			return 
		end
	end
	if FrontMissiontId2 ~= -1 then
		if IsQuestHaveDoneNM( sceneId, selfId, FrontMissiontId2 ) == 0 then
			return 
		end
	end
	if FrontMissiontId3 ~= -1 then
		if IsQuestHaveDoneNM( sceneId, selfId, FrontMissiontId3 ) == 0 then
			return
		end
	end

	if AddQuestNM( sceneId, selfId,MissionId) == 1 then
		local missionDesc = x300904_GetMissionDesc(sceneId, selfId)
		BeginQuestEvent(sceneId)
		--接任务写日志
		GamePlayScriptLog(sceneId,selfId,101)

 		AddQuestText(sceneId, "你接受了任务："..missionDesc.MissionName)
 		EndQuestEvent(sceneId)
		DispatchQuestTips(sceneId,selfId)
		local Readme = "你接受了任务："..missionDesc.MissionName
		Msg2Player(sceneId,selfId,Readme,8,2)	

		local misIndex = GetQuestIndexByID( sceneId, selfId, MissionId )
		SetQuestByIndex(sceneId, selfId, misIndex, 7, 0);
		SetQuestByIndex(sceneId, selfId, misIndex, 0, 0);
	end
	
end

--完成任务
--返回1代表成功，0代表交任务失败
function x300904_ProcQuestSubmit( sceneId, selfId, targetId, selectId, MissionId )
	if IsHaveQuestNM( sceneId, selfId, MissionId) == 0 then	-- 如果没这个任务直接退出
		return 0
	end
	local missionDesc = x300904_GetMissionDesc(sceneId, selfId)
	if DelQuestNM( sceneId, selfId, MissionId) < 1 then
		return 
	end

    -- 增加活跃度
    local id = GetGuildID( sceneId, selfId)
    if id ~= -1 then
        AddGuildActivity( sceneId, selfId, GetGuildCacheFreeParam( id, GD_GUILD_ACTIVITY_PARAM1) )
    end
	CallScriptFunction( 256266, "Finishdanmu", sceneId, selfId)
	GamePlayScriptLog(sceneId,selfId,102)

	x300904_SetDayCount(sceneId, selfId)
	GetGuildQuestData(sceneId, selfId, GD_GUILD_INDEX_MULTI_MISSION_HEIMU, x300904_g_ScriptId,MissionId,"OnReturn1",missionDesc.MissionId)
	return 0
end

function x300904_ProcQuestAttach( sceneId, selfId, npcId, npcGuid,misIndex, MissionId )

	for i,itm in x300904_g_SubMissionId do
		local bHaveMission = IsHaveQuestNM(sceneId, selfId,itm.MissionId );

		if bHaveMission > 0 then
			if npcGuid == itm.SubmitNPCGUID then
				local nCheckItemId = GetItemCount( sceneId, selfId, itm.itmID )
				if  nCheckItemId >=5 then
					local state = GetQuestStateNM(sceneId,selfId,npcId,itm.MissionId)
					AddQuestNumText(sceneId, itm.MissionId, itm.MissionName,7,state);
				else
					local state = GetQuestStateNM(sceneId,selfId,npcId,itm.MissionId)
					AddQuestNumText(sceneId, itm.MissionId, itm.MissionName,6,state);
				end
				break;
			end
		end
	end

end

--********************************************************************
--放弃
--********************************************************************
function x300904_ProcQuestAbandon( sceneId, selfId,MissionId )
	
	if IsHaveQuestNM( sceneId, selfId, MissionId) == 0 then	-- 如果没有这个任务
		return
	end
	local missionDesc = x300904_GetMissionDesc(sceneId, selfId)
	DelQuestNM( sceneId, selfId, MissionId)
	local Readme = "你放弃了任务："..missionDesc.MissionName
	BeginQuestEvent(sceneId)
	AddQuestText(sceneId, Readme);
    EndQuestEvent(sceneId)
	DispatchQuestTips(sceneId,selfId)
	Msg2Player(sceneId,selfId,Readme,8,2)
	x300904_SetDayCount(sceneId, selfId)
end

function x300904_CheckWhichItem(sceneId, selfId)
	for i,itm in x300904_g_SubMissionId do
		if IsHaveQuestNM(sceneId, selfId,itm.MissionId ) > 0 then
			return itm.itmID
		end
	end
	return 0
end

function x300904_GetMissionDesc(sceneId, selfId)
	for i,itm in x300904_g_SubMissionId do
		if IsHaveQuestNM(sceneId, selfId,itm.MissionId ) > 0 then
			return itm
		end
	end
	return nil
end

function x300904_ProcQuestItemChanged( sceneId, selfId, itemdataId, MissionId, nChangeType )
	local nCheckItemId = x300904_CheckWhichItem(sceneId, selfId)
	if nCheckItemId ~= itemdataId then
		return
	end

    if MissionId == nil or MissionId < 0 then
        return
    end
    
    if IsHaveQuestNM(sceneId,selfId,MissionId) <= 0 then
        return
    end
	
  	local NeedNum, ObjIndex = GetQuestNeedItemNumNM( sceneId, selfId, MissionId, itemdataId )
	local misIndex = GetQuestIndexByID( sceneId, selfId, MissionId )

	if nChangeType ==1 then
		--删除道具
		local itemNum = GetItemCount( sceneId, selfId, itemdataId )
		if itemNum < NeedNum then
			SetQuestByIndex( sceneId, selfId, misIndex, 0, itemNum )
			SetQuestByIndex( sceneId, selfId, misIndex, 7, 0 )
			x300904_QuestLogRefresh( sceneId, selfId, MissionId );
		end
		return
	end
	
	if NeedNum <= 0 then
		return
	end
	

	local Num = GetItemCount( sceneId, selfId, itemdataId )
	if Num < NeedNum and Num > 0 then --还没有完成任务
		BeginQuestEvent(sceneId)
		local strText = format("已得到@itemid_%d: %d/%d", itemdataId, Num, NeedNum )
		if strText == nil then
			strText = "";
		end
		AddQuestText( sceneId, strText )
		EndQuestEvent( sceneId )
		DispatchQuestTips( sceneId, selfId )
		SetQuestByIndex( sceneId, selfId, misIndex, 0, Num )
		x300904_QuestLogRefresh( sceneId, selfId, MissionId );
	elseif Num >= NeedNum then
		--已经完成任务
		BeginQuestEvent(sceneId)
		local strText = format( "已得到足够的@itemid_%d: %d/%d", itemdataId, Num, NeedNum )
		if strText == nil then
			strText = "";
		end
		AddQuestText( sceneId, strText )
		EndQuestEvent( sceneId )
		DispatchQuestTips( sceneId, selfId )
		SetQuestByIndex( sceneId, selfId, misIndex, 7, 1 )
		SetQuestByIndex( sceneId, selfId, misIndex, 0, Num )
		x300904_QuestLogRefresh( sceneId, selfId, MissionId );
	end

end

function x300904_QuestLogRefresh( sceneId, selfId, MissionId)


	local bHaveMission = IsHaveQuestNM(sceneId, selfId,MissionId );
	if bHaveMission <= 0 then
		return
	end
	
	BeginQuestEvent(sceneId)	
	local level = GetLevel(sceneId, selfId)
	local ExpBonus = ceil ( (100 * 3 * level * 20*1*1 ) )
	ExpBonus =floor(ExpBonus+0.5)
	if ExpBonus > 0 then
	AddQuestExpBonus(sceneId, ExpBonus);		
	end
	if x300904_g_BonusMoney8 > 0 then
	AddQuestMoneyBonus8(sceneId, x300904_g_BonusMoney8 )	--增加帮贡
	end
	-- if x300904_g_GuildExpBonus>0 then
	-- AddQuestGuildExpBonus(sceneId,x300904_g_GuildExpBonus)
	-- end

	local nCheckItemId = x300904_CheckWhichItem(sceneId, selfId)
	if 0 == nCheckItemId then
		return
	end
	local itemNum = GetItemCount( sceneId, selfId, nCheckItemId )
	local NeedNum, ObjIndex = GetQuestNeedItemNumNM( sceneId, selfId, MissionId, nCheckItemId )	
	if itemNum >= NeedNum then
		itemNum = NeedNum
	end
	local text = format("(%d/%d)",itemNum,NeedNum)
	local missionDesc = x300904_GetMissionDesc(sceneId, selfId)
	if nil == missionDesc then
		return
	end
	AddQuestLogCustomText( sceneId,
							"",						-- 标题
							missionDesc.MissionName,        -- 任务名字
							missionDesc.MissionTarget..text,		--任务目标
							missionDesc.NpcName,			--任务NPC
							missionDesc.Missionruse,               --任务攻略
							missionDesc.MissionInfo,	--任务描述
							"每张领地地图都有古老的图腾，请根据自身等级进行选择。随着你所在帮会等级的提高，你获得的奖励也会相应增加。"					--任务小提示
							)
	EndQuestEvent(sceneId)
	DispatchQuestLogUpdate(sceneId, selfId, MissionId);
end

function x300904_ProcQuestLogRefresh( sceneId, selfId, MissionId)

	x300904_QuestLogRefresh( sceneId, selfId, MissionId );
end

---------------------------------------------------------------------------------------------------
--取得此任务当天当前已完成次数
---------------------------------------------------------------------------------------------------
function x300904_GetDayCount(sceneId, selfId)

	if x300904_g_Mis_Count > 0 then

		local today = GetDayOfYear()

		local lastday = GetQuestData(sceneId, selfId, MD_GUILD_GATHER_DATE[1], MD_GUILD_GATHER_DATE[2], MD_GUILD_GATHER_DATE[3])

		if lastday ~= today then
			return 0
		end

		local daycount =  GetQuestData(sceneId, selfId, MD_GUILD_GATHER_COUNT[1], MD_GUILD_GATHER_COUNT[2], MD_GUILD_GATHER_COUNT[3])
		return daycount

	end

	return 0
end

--------------------------------------------------------------------------------------------------
--更新当天接任务次数
---------------------------------------------------------------------------------------------------
function x300904_SetDayCount(sceneId, selfId)
	local today = GetDayOfYear()

	local lastday = GetQuestData(sceneId, selfId, MD_GUILD_GATHER_DATE[1], MD_GUILD_GATHER_DATE[2], MD_GUILD_GATHER_DATE[3])

	if lastday ~= today then
		SetQuestData(sceneId, selfId, MD_GUILD_GATHER_DATE[1], MD_GUILD_GATHER_DATE[2], MD_GUILD_GATHER_DATE[3], today)
		SetQuestData(sceneId, selfId, MD_GUILD_GATHER_COUNT[1], MD_GUILD_GATHER_COUNT[2], MD_GUILD_GATHER_COUNT[3], 1)
	else
		local daycount = GetQuestData(sceneId, selfId, MD_GUILD_GATHER_COUNT[1], MD_GUILD_GATHER_COUNT[2], MD_GUILD_GATHER_COUNT[3])
		SetQuestData(sceneId, selfId, MD_GUILD_GATHER_COUNT[1], MD_GUILD_GATHER_COUNT[2], MD_GUILD_GATHER_COUNT[3], daycount+1)
	end
end


