
--MisDescBegin

x300782_g_ScriptId = 300782                 --脚本ID
x300782_g_LevelLess					= 	20

--MisDescEnd

--好友任务
x300782_g_GuidParamIndex = 6
x300782_g_NeedFriendpoint = 0
x300782_g_MissionId = 9200
x300782_g_SubMission = {}
x300782_g_TotalMissionNum = 0
x300782_g_MaxTimes = 10
x300782_g_LimitTimes = 5
x300782_g_GMSelectMissionId = 0
x300782_g_LootItem={9100,9101,9102,9103,9104,9105}

x300782_g_UseItem = {
{missionId=	9110	,item=	13013600	,scene={50,150,250,350}, posX=	374	,posZ=	290	},
{missionId=	9111	,item=	13013600	,scene={50,150,250,350}, posX=	472	,posZ=	136	},
{missionId=	9112	,item=	13013600	,scene={50,150,250,350}, posX=	117	,posZ=	258	},
{missionId=	9113	,item=	13013600	,scene={50,150,250,350}, posX=	319	,posZ=	297	},
{missionId=	9114	,item=	13013600	,scene={50,150,250,350}, posX=	137	,posZ=	41	},
{missionId=	9115	,item=	13013600	,scene={50,150,250,350}, posX=	370	,posZ=	382	}
}

x300782_g_KillMonster = {
{missionId=	9120	,num=	1, monsterDataId= 3070, level=20	},
{missionId=	9121	,num=	1, monsterDataId= 3071, level=20	},
{missionId=	9122	,num=	1, monsterDataId= 3072, level=20	},
{missionId=	9123	,num=	1, monsterDataId= 3073, level=20	},
{missionId=	9124	,num=	1, monsterDataId= 3074, level=20	},
{missionId=	9125	,num=	1, monsterDataId= 3075, level=20	},
{missionId=	9126	,num=	1, monsterDataId= 3076, level=25	},
{missionId=	9127	,num=	1, monsterDataId= 3077, level=25	},
{missionId=	9128	,num=	1, monsterDataId= 3078, level=25	},
{missionId=	9129	,num=	1, monsterDataId= 3079, level=30	},
{missionId=	9130	,num=	1, monsterDataId= 3080, level=30	},
{missionId=	9131	,num=	1, monsterDataId= 3081, level=30	},
{missionId=	9132	,num=	1, monsterDataId= 3082, level=35	},
{missionId=	9133	,num=	1, monsterDataId= 3083, level=35	},
{missionId=	9134	,num=	1, monsterDataId= 3084, level=35	},
}

x300782_g_UnUseMission = {
{missionId=	9135	,num=	1, monsterDataId= 3085, level=40	},
{missionId=	9136	,num=	1, monsterDataId= 3086, level=40	},
{missionId=	9137	,num=	1, monsterDataId= 3087, level=40	},
{missionId=	9138	,num=	1, monsterDataId= 3088, level=45	},
{missionId=	9139	,num=	1, monsterDataId= 3089, level=45	},
{missionId=	9140	,num=	1, monsterDataId= 3090, level=45	},
{missionId=	9141	,num=	1, monsterDataId= 3091, level=50	},
{missionId=	9142	,num=	1, monsterDataId= 3092, level=50	},
{missionId=	9143	,num=	1, monsterDataId= 3093, level=50	},
{missionId=	9144	,num=	1, monsterDataId= 3094, level=55	},
{missionId=	9145	,num=	1, monsterDataId= 3095, level=55	},
{missionId=	9146	,num=	1, monsterDataId= 3096, level=55	},
{missionId=	9147	,num=	1, monsterDataId= 3097, level=60	},
{missionId=	9148	,num=	1, monsterDataId= 3098, level=60	},
{missionId=	9149	,num=	1, monsterDataId= 3099, level=60	},
{missionId=	9150	,num=	1, monsterDataId= 3100, level=65	},
{missionId=	9151	,num=	1, monsterDataId= 3101, level=65	},
{missionId=	9152	,num=	1, monsterDataId= 3102, level=65	},
{missionId=	9153	,num=	1, monsterDataId= 3103, level=70	},
{missionId=	9154	,num=	1, monsterDataId= 3104, level=70	},
{missionId=	9155	,num=	1, monsterDataId= 3105, level=70	},
{missionId=	9156	,num=	1, monsterDataId= 3106, level=75	},
{missionId=	9157	,num=	1, monsterDataId= 3107, level=75	},
{missionId=	9158	,num=	1, monsterDataId= 3108, level=75	},
{missionId=	9159	,num=	1, monsterDataId= 3109, level=80	},
{missionId=	9160	,num=	1, monsterDataId= 3110, level=80	},
{missionId=	9161	,num=	1, monsterDataId= 3111, level=80	}
}

x300782_g_PostMail = {
{missionId=	9170	,item=	13013800, npcGuid=138813	},
{missionId=	9171	,item=	13013800, npcGuid=138605	},
{missionId=	9172	,item=	13013800, npcGuid=138110	},
{missionId=	9173	,item=	13013800, npcGuid=138114	},
{missionId=	9174	,item=	13013800, npcGuid=138255	},
{missionId=	9175	,item=	13013800, npcGuid=138117	},
{missionId=	9176	,item=	13013800, npcGuid=138586	},
{missionId=	9177	,item=	13013800, npcGuid=138257	},
}

x300782_g_MissionType={
LootItem = 1,
UseItem = 2,
KillMonster = 3,
PostMail = 4,
}

x300782_g_addFriendPoint = 50
x300782_g_MissionName ="【好友】肝胆相照"
x300782_g_SubmitNPC = 138576
function x300782_GMCommand(param0, param1, param2)
	x300782_g_GMSelectMissionId = param0
end

function x300782_LoadAllSubMission()
	local index = 1
	for i, mission in x300782_g_LootItem do
		x300782_g_SubMission[index] = mission
		index = index + 1
	end
	for i, mission in x300782_g_UseItem do
		x300782_g_SubMission[index] = mission.missionId
		index = index + 1
	end
	for i, mission in x300782_g_KillMonster do
		x300782_g_SubMission[index] = mission.missionId
		index = index + 1
	end
	for i, mission in x300782_g_PostMail do
		x300782_g_SubMission[index] = mission.missionId
		index = index + 1
	end
	x300782_g_TotalMissionNum = index - 1
end

function x300782_RandomMission(sceneId, selfId, targetId)
	local randomTable = {}
	local myLevel = GetLevel(sceneId, selfId)
	local targetLevel = GetLevel(sceneId, targetId)
	local average = myLevel
	if myLevel > targetLevel then
		average = targetLevel
	end
	local beginIndex
	local endIndex
	if average >= 40 then
		beginIndex = 1
		endIndex = 15
	elseif average >= 35 then
		beginIndex = 13
		endIndex = beginIndex + 2
	elseif average >= 30 then
		beginIndex = 10
		endIndex = beginIndex + 2
	elseif average >= 25 then
		beginIndex = 7
		endIndex = beginIndex + 2
	elseif average >= 20 then
		beginIndex = 1
		endIndex = 6
	end
	
	local index = 1
	for i, mission in x300782_g_LootItem do
		randomTable[index] = mission
		index = index + 1
	end
	for i, mission in x300782_g_UseItem do
		randomTable[index] = mission.missionId
		index = index + 1
	end
	for i, mission in x300782_g_PostMail do
		randomTable[index] = mission.missionId
		index = index + 1
	end
	for i=beginIndex, endIndex do
		randomTable[index] = x300782_g_KillMonster[i].missionId
		index = index + 1
	end
	local randomIndex = random(1, index - 1)
	if x300782_g_GMSelectMissionId > 0 then
		return x300782_g_GMSelectMissionId
	end
	return randomTable[randomIndex]
end

x300782_LoadAllSubMission()

function x300782_GetMissionInfo(missionId)
	local nIndex = 1
	for i, mission in x300782_g_LootItem do
		if mission == missionId then
			return x300782_g_MissionType.LootItem,nIndex
		end
		nIndex = nIndex + 1
	end

	nIndex = 1
	for i, mission in x300782_g_UseItem do
		if mission.missionId == missionId then
			return x300782_g_MissionType.UseItem,nIndex
		end
		nIndex = nIndex + 1
	end

	nIndex = 1
	for i, mission in x300782_g_KillMonster do
		if mission.missionId == missionId then
			return x300782_g_MissionType.KillMonster,nIndex
		end
		nIndex = nIndex + 1
	end

	nIndex = 1
	for i, mission in x300782_g_PostMail do
		if mission.missionId == missionId then
			return x300782_g_MissionType.PostMail,nIndex
		end
		nIndex = nIndex + 1
	end
	return -1,-1
end

function x300782_DeleteAllSubMission( sceneId, selfId )
	for i, mission in x300782_g_SubMission do
		DelQuestNM( sceneId, selfId, mission )
	end
	for i, mission in x300782_g_UnUseMission do
		DelQuestNM( sceneId, selfId, mission.missionId )
	end
	
end

function x300782_IsSubMission( sceneId, selfId, MissionId )
	for i, mission in x300782_g_SubMission do
		if tonumber(MissionId) == tonumber(mission) then
			return 1
		end
	end
	return -1
end

function x300782_HaveWhichSubMission(sceneId, selfId)
	for i, mission in x300782_g_SubMission do
		if IsHaveQuestNM( sceneId, selfId, mission ) == 1 then
			return mission
		end
	end
	return -1
end

function x300782_IsHaveSubMission(sceneId, selfId)
	for i, mission in x300782_g_SubMission do
		if IsHaveQuestNM( sceneId, selfId, mission ) == 1 then
			return 1
		end
	end
	return -1
end

function x300782_HaveDoneWhichSubMission(sceneId, selfId, targetId)

	for i, mission in x300782_g_SubMission do
		if IsHaveQuestNM( sceneId, selfId, mission ) == 1 then
		
			local misIndex = GetQuestIndexByID( sceneId, selfId, mission )
			if QuestCheckSubmitNM( sceneId, selfId, targetId, mission, misIndex ) > 0 then
				return mission
			end
			if GetQuestParam( sceneId, selfId, misIndex, 7 ) == 1 then
				return mission
			end
		end
	end
	return -1
end

function x300782_GetMissionTimes(sceneId, selfId)
	if GetQuestData(sceneId, selfId, MD_FRIEND_COMPLETE_DAY[1], MD_FRIEND_COMPLETE_DAY[2], MD_FRIEND_COMPLETE_DAY[3]) ~= GetDayOfYear() then
		return 0
	else
		return GetQuestData(sceneId, selfId, MD_FRIEND_COMPLETE_TIMES[1], MD_FRIEND_COMPLETE_TIMES[2], MD_FRIEND_COMPLETE_TIMES[3])
	end
end

function x300782_SetFriendGUID(sceneId, selfId, guid)
	
	local missionId = x300782_HaveWhichSubMission(sceneId, selfId)
	local misIndex = GetQuestIndexByID( sceneId, selfId, missionId )
	SetQuestByIndex( sceneId, selfId, misIndex, x300782_g_GuidParamIndex, guid )
	
	if 0 == GetQuestData(sceneId, selfId, MD_FRIEND_GUID_1[1], MD_FRIEND_GUID_1[2], MD_FRIEND_GUID_1[3]) then
		SetQuestData(sceneId, selfId, MD_FRIEND_GUID_1[1], MD_FRIEND_GUID_1[2], MD_FRIEND_GUID_1[3], guid)
	elseif 0 == GetQuestData(sceneId, selfId, MD_FRIEND_GUID_2[1], MD_FRIEND_GUID_2[2], MD_FRIEND_GUID_2[3]) then
		SetQuestData(sceneId, selfId, MD_FRIEND_GUID_2[1], MD_FRIEND_GUID_2[2], MD_FRIEND_GUID_2[3], guid)
	elseif 0 == GetQuestData(sceneId, selfId, MD_FRIEND_GUID_3[1], MD_FRIEND_GUID_3[2], MD_FRIEND_GUID_3[3]) then
		SetQuestData(sceneId, selfId, MD_FRIEND_GUID_3[1], MD_FRIEND_GUID_3[2], MD_FRIEND_GUID_3[3], guid)
	elseif 0 == GetQuestData(sceneId, selfId, MD_FRIEND_GUID_4[1], MD_FRIEND_GUID_4[2], MD_FRIEND_GUID_4[3]) then
		SetQuestData(sceneId, selfId, MD_FRIEND_GUID_4[1], MD_FRIEND_GUID_4[2], MD_FRIEND_GUID_4[3], guid)
	elseif 0 == GetQuestData(sceneId, selfId, MD_FRIEND_GUID_5[1], MD_FRIEND_GUID_5[2], MD_FRIEND_GUID_5[3]) then
		SetQuestData(sceneId, selfId, MD_FRIEND_GUID_5[1], MD_FRIEND_GUID_5[2], MD_FRIEND_GUID_5[3], guid)
	end
	
	if GetQuestData(sceneId, selfId, MD_FRIEND_COMPLETE_DAY[1], MD_FRIEND_COMPLETE_DAY[2], MD_FRIEND_COMPLETE_DAY[3]) ~= GetDayOfYear() then
		SetQuestData(sceneId, selfId, MD_FRIEND_COMPLETE_TIMES[1], MD_FRIEND_COMPLETE_TIMES[2], MD_FRIEND_COMPLETE_TIMES[3], 1)
	else
		local times = GetQuestData(sceneId, selfId, MD_FRIEND_COMPLETE_TIMES[1], MD_FRIEND_COMPLETE_TIMES[2], MD_FRIEND_COMPLETE_TIMES[3])
		times = times + 1
		SetQuestData(sceneId, selfId, MD_FRIEND_COMPLETE_TIMES[1], MD_FRIEND_COMPLETE_TIMES[2], MD_FRIEND_COMPLETE_TIMES[3], times)
	end
	
	local friendName = GetFriendName(sceneId, selfId, guid)
	local times = GetQuestData(sceneId, selfId, MD_FRIEND_COMPLETE_TIMES[1], MD_FRIEND_COMPLETE_TIMES[2], MD_FRIEND_COMPLETE_TIMES[3])
	local msg = format("你今天进行了%d次本任务,与此任务对应的好友是：%s", times, friendName)
	Msg2Player(sceneId,selfId,msg,8,2)
	BeginQuestEvent(sceneId);
	AddQuestText(sceneId, msg);
	EndQuestEvent();
	DispatchQuestTips(sceneId, selfId);
	
	SetQuestData(sceneId, selfId, MD_FRIEND_COMPLETE_DAY[1], MD_FRIEND_COMPLETE_DAY[2], MD_FRIEND_COMPLETE_DAY[3], GetDayOfYear())
end

function x300782_UpdateTimes(sceneId, selfId)
	if GetQuestData(sceneId, selfId, MD_FRIEND_COMPLETE_DAY[1], MD_FRIEND_COMPLETE_DAY[2], MD_FRIEND_COMPLETE_DAY[3]) ~= GetDayOfYear() then
		SetQuestData(sceneId, selfId, MD_FRIEND_COMPLETE_TIMES[1], MD_FRIEND_COMPLETE_TIMES[2], MD_FRIEND_COMPLETE_TIMES[3], 1)
		SetQuestData(sceneId, selfId, MD_FRIEND_COMPLETE_DAY[1], MD_FRIEND_COMPLETE_DAY[2], MD_FRIEND_COMPLETE_DAY[3], GetDayOfYear())
		
		local guid = x300782_GetFriendGUID(sceneId, selfId)
		
		SetQuestData(sceneId, selfId, MD_FRIEND_GUID_1[1], MD_FRIEND_GUID_1[2], MD_FRIEND_GUID_1[3], 0)
		SetQuestData(sceneId, selfId, MD_FRIEND_GUID_2[1], MD_FRIEND_GUID_2[2], MD_FRIEND_GUID_2[3], 0)
		SetQuestData(sceneId, selfId, MD_FRIEND_GUID_3[1], MD_FRIEND_GUID_3[2], MD_FRIEND_GUID_3[3], 0)
		SetQuestData(sceneId, selfId, MD_FRIEND_GUID_4[1], MD_FRIEND_GUID_4[2], MD_FRIEND_GUID_4[3], 0)
		SetQuestData(sceneId, selfId, MD_FRIEND_GUID_5[1], MD_FRIEND_GUID_5[2], MD_FRIEND_GUID_5[3], 0)
		
		SetQuestData(sceneId, selfId, MD_FRIEND_GUID_1[1], MD_FRIEND_GUID_1[2], MD_FRIEND_GUID_1[3], guid)
		
	end
end

function x300782_CheckFriendTimes(sceneId, selfId, friendGuid)
	if GetQuestData(sceneId, selfId, MD_FRIEND_COMPLETE_DAY[1], MD_FRIEND_COMPLETE_DAY[2], MD_FRIEND_COMPLETE_DAY[3]) ~= GetDayOfYear() then
		SetQuestData(sceneId, selfId, MD_FRIEND_GUID_1[1], MD_FRIEND_GUID_1[2], MD_FRIEND_GUID_1[3], 0)
		SetQuestData(sceneId, selfId, MD_FRIEND_GUID_2[1], MD_FRIEND_GUID_2[2], MD_FRIEND_GUID_2[3], 0)
		SetQuestData(sceneId, selfId, MD_FRIEND_GUID_3[1], MD_FRIEND_GUID_3[2], MD_FRIEND_GUID_3[3], 0)
		SetQuestData(sceneId, selfId, MD_FRIEND_GUID_4[1], MD_FRIEND_GUID_4[2], MD_FRIEND_GUID_4[3], 0)
		SetQuestData(sceneId, selfId, MD_FRIEND_GUID_5[1], MD_FRIEND_GUID_5[2], MD_FRIEND_GUID_5[3], 0)
	end
	if friendGuid == GetQuestData(sceneId, selfId, MD_FRIEND_GUID_1[1], MD_FRIEND_GUID_1[2], MD_FRIEND_GUID_1[3]) then
		return 0
	elseif friendGuid == GetQuestData(sceneId, selfId, MD_FRIEND_GUID_2[1], MD_FRIEND_GUID_2[2], MD_FRIEND_GUID_2[3]) then
		return 0
	elseif friendGuid == GetQuestData(sceneId, selfId, MD_FRIEND_GUID_3[1], MD_FRIEND_GUID_3[2], MD_FRIEND_GUID_3[3]) then
		return 0
	elseif friendGuid == GetQuestData(sceneId, selfId, MD_FRIEND_GUID_4[1], MD_FRIEND_GUID_4[2], MD_FRIEND_GUID_4[3]) then
		return 0
	elseif friendGuid == GetQuestData(sceneId, selfId, MD_FRIEND_GUID_5[1], MD_FRIEND_GUID_5[2], MD_FRIEND_GUID_5[3]) then
		return 0
	end
	return 1
end

function x300782_GetFriendGUID(sceneId, selfId)
	local missionId = x300782_HaveWhichSubMission(sceneId, selfId)
	local misIndex = GetQuestIndexByID( sceneId, selfId, missionId )
	local guid = GetQuestParam( sceneId, selfId, misIndex, x300782_g_GuidParamIndex )
	guid = tonumber(format("%u",guid))
	return guid
end


--**********************************

--任务入口函数

--**********************************

function x300782_IsFriendHere(sceneId, selfId)
	local teamSize = GetTeamSize(sceneId, selfId)
	if (teamSize ~= 2) then
		local friendName = GetFriendName(sceneId, selfId, x300782_GetFriendGUID(sceneId, selfId))
		if "" ~= friendName then
			return "你应该与" .. friendName .. "两人组队来进行此任务。"
		end
		return "请你和你的朋友两人组队来进行此任务。";
	end

	local nearTeamSize = GetNearTeamCount(sceneId, selfId)

	if teamSize ~= nearTeamSize then
		return "你和你的朋友必须都在附近。"
	end

	local targetId = GetNearTeamMember(sceneId, selfId, 0)
	
	if targetId == selfId then
		targetId = GetNearTeamMember(sceneId, selfId, 1)
	end
	
	if IsInDist(sceneId, selfId, targetId, 30) ~= 1 then
		return "你和你的朋友必须都在附近。"
	end

	if IsFriend(sceneId, selfId, targetId) ~= 1 then
		return "请互相添加对方为好友再来进行此任务。";
	end
	
	if IsFriend(sceneId, targetId, selfId ) ~= 1 then
		return "请互相添加对方为好友再来进行此任务。";
	end
	
	if x300782_GetFriendGUID(sceneId, selfId) ~= GetGUID(sceneId, targetId) then
		local friendName = GetFriendName(sceneId, selfId, x300782_GetFriendGUID(sceneId, selfId))
		if "" ~= friendName then
			return "你应该与" .. friendName .. "两人组队来进行此任务。"
		end
	end
	
	if x300782_GetFriendGUID(sceneId, targetId) ~= GetGUID(sceneId, selfId) then
		local friendName = GetFriendName(sceneId, targetId, x300782_GetFriendGUID(sceneId, targetId))
		if "" ~= friendName then
			return "你的队友应该与" .. friendName .. "两人组队来进行此任务。"
		end
	end
	
	local selfHaveMission = x300782_HaveWhichSubMission(sceneId, selfId)
	local friendHaveMission = x300782_HaveWhichSubMission(sceneId, targetId)
	
	if selfHaveMission ~= friendHaveMission then
		return "你的好友已经放弃任务，请你删除任务。"
	end
	
	if IsPlayerStateNormal(sceneId, selfId) <= 0 or GetHp(sceneId, selfId) <= 0 then
		return "你当前状态无法进行此任务。"
	end
	
	if IsPlayerStateNormal(sceneId, targetId) <= 0 or GetHp(sceneId, targetId) <= 0 then
		return "你好友的当前状态无法进行此任务。"
	end
	
	return nil
		
end

--
function x300782_IsFriendCompleteMission(sceneId, selfId, NPC)

	local bLeader = IsTeamLeader( sceneId, selfId )
	if bLeader ~= 1 then
		--return "你不是队长，只有队长才能提交本任务。"
	end
	
	local ret = x300782_IsFriendHere(sceneId, selfId)
	if ret ~= nil then
		return ret
	end
	
	local targetId = GetNearTeamMember(sceneId, selfId, 0)
	
	if targetId == selfId then
		targetId = GetNearTeamMember(sceneId, selfId, 1)
	end
	
	local selfHaveMission = x300782_HaveWhichSubMission(sceneId, selfId, NPC)
	local friendHaveMission = x300782_HaveWhichSubMission(sceneId, targetId, NPC)
	
	if selfHaveMission ~= friendHaveMission then
		return "你的好友已经放弃任务，请你手动删除任务。"
	end
	
	local selfCompleteMission = x300782_HaveDoneWhichSubMission(sceneId, selfId, NPC)
	local friendCompleteMission = x300782_HaveDoneWhichSubMission(sceneId, targetId, NPC)
	
	if friendCompleteMission ~= selfCompleteMission then
		return "你的好友还没有完成此任务。"
	end
end

function x300782_IsFriendHaveSameUncompleteMission(sceneId, selfId, NPC)
	local ret = x300782_IsFriendHere(sceneId, selfId)
	if ret ~= nil then
		return ret
	end
	
	local targetId = GetNearTeamMember(sceneId, selfId, 0)
	
	if targetId == selfId then
		targetId = GetNearTeamMember(sceneId, selfId, 1)
	end
	
	local selfHaveMission = x300782_HaveWhichSubMission(sceneId, selfId, NPC)
	local friendHaveMission = x300782_HaveWhichSubMission(sceneId, targetId, NPC)
	
	if selfHaveMission ~= friendHaveMission then
		return "你的好友已经放弃任务，请你手动删除任务。"
	end
	
	local misIndex = GetQuestIndexByID( sceneId, targetId, friendHaveMission )
	if GetQuestParam( sceneId, targetId, misIndex, 7 ) == 1 then
		return "你的好友已经完成此了此任务。"
	end
	
end

function x300782_ProcEventEntry( sceneId, selfId, targetId, MissionId, index )
	local haveSubMissionId = x300782_HaveWhichSubMission(sceneId, selfId)

	local missionType,nIndex = x300782_GetMissionInfo(haveSubMissionId)
	if missionType == x300782_g_MissionType.PostMail then
		local misIndex = GetQuestIndexByID( sceneId, selfId, haveSubMissionId )
		if GetQuestParam( sceneId, selfId, misIndex, 7 ) ~= 1 then
			
			local ret = x300782_IsFriendHaveSameUncompleteMission(sceneId, selfId)
			if ret ~= nil then
				Msg2Player(sceneId,selfId,ret,8,2)
				BeginQuestEvent(sceneId);
				AddQuestText(sceneId, ret);
				EndQuestEvent();
				DispatchQuestTips(sceneId, selfId);
				return
			end
			
			SetQuestByIndex( sceneId, selfId, misIndex, 0, 1 )
			SetQuestByIndex( sceneId, selfId, misIndex, 7, 1 )
			--DelItem(sceneId, selfId, x300782_g_PostMail[1].item, 1)
			
			local friendId = GetNearTeamMember(sceneId, selfId, 0)
			if friendId == selfId then
				friendId = GetNearTeamMember(sceneId, selfId, 1)
			end
			local friendMisIndex = GetQuestIndexByID( sceneId, friendId, haveSubMissionId )
			SetQuestByIndex( sceneId, friendId, friendMisIndex, 0, 1 )
			SetQuestByIndex( sceneId, friendId, friendMisIndex, 7, 1 )
			--DelItem(sceneId, friendId, x300782_g_PostMail[1].item, 1)
			
			BeginQuestEvent(sceneId)
			AddQuestText(sceneId,"#Y【好友】肝胆相照")
			AddQuestText(sceneId,"\t你们如此真诚，又怎能不是至交好友呢？希望彼此的友谊能一直延续下去。")
			EndQuestEvent()
			
			
			DispatchQuestDemandInfo(sceneId, selfId, targetId, x300782_g_ScriptId, MissionId,0);
			DispatchQuestDemandInfo(sceneId, friendId, targetId, x300782_g_ScriptId, MissionId,0);
			
			x300782_QuestLogRefresh( sceneId, selfId, haveSubMissionId)
			x300782_QuestLogRefresh( sceneId, friendId, haveSubMissionId)
			QuestCom( sceneId, selfId, haveSubMissionId)
			QuestCom( sceneId, friendId, haveSubMissionId)
			--x300782_QuestLogRefresh(sceneId, selfId, haveSubMissionId)
			return
		end
	end



	local haveDoneMissionId = -1
	if haveSubMissionId > 0 then
		haveDoneMissionId = x300782_HaveDoneWhichSubMission(sceneId, selfId, targetId)
	end

	if haveDoneMissionId > 0 then
		local ret = x300782_IsFriendCompleteMission(sceneId, selfId, targetId)
		if ret ~= nil then
			Msg2Player(sceneId,selfId,ret,8,2)
			BeginQuestEvent(sceneId);
			AddQuestText(sceneId, ret);
			EndQuestEvent();
			DispatchQuestTips(sceneId, selfId);
			return
		end
		BeginQuestEvent(sceneId)
		AddQuestText(sceneId,"#Y【好友】肝胆相照")
		AddQuestText(sceneId,"\t祝你们友谊地久天长！#r")
		local friendshipLevel = GetFriendshipLevelByGuid(sceneId, selfId, x300782_GetFriendGUID(sceneId, selfId))
		local selfLevel = GetLevel(sceneId, selfId)
		local exp = x300782_CalculateExp(friendshipLevel,selfLevel)
			local szAward = "\n#Y奖励内容：\n#W经验值:"..exp.."点"
		AddQuestText(sceneId, szAward)
		EndQuestEvent()
	  DispatchQuestContinueInfoNM(sceneId, selfId, targetId, x300782_g_ScriptId, MissionId);
	  return
	end

	if haveSubMissionId > 0 then
		BeginQuestEvent(sceneId)
		AddQuestText(sceneId,"#Y【好友】肝胆相照")
		AddQuestText(sceneId,"\t赶快去完成交付于你们的任务吧！#r")
		EndQuestEvent()
		DispatchQuestDemandInfo(sceneId, selfId, targetId, x300782_g_ScriptId, MissionId,0);
		return
	end

	BeginQuestEvent(sceneId)
	AddQuestText(sceneId,"#Y【好友】肝胆相照#W\n\t行走在江湖之上，没有朋友就失去了半边天。如果想和你的好友一起来完成任务，您可以和您的好友两人组队来找我。成功完成我的任务，您将获得经验奖励！\n\t注：每天只能完成5次任务。任务进行中如果有人放弃了任务，则即使完成任务也不会获得经验。\n\t本任务只有每周三才可接取。\n\t当天一对好友只能进行一次本任务。#W")
	EndQuestEvent()
	--DispatchQuestDemandInfo(sceneId, selfId, targetId, x300782_g_ScriptId, x300782_g_MissionId,0);
	DispatchQuestInfo(sceneId, selfId, targetId, x300782_g_MissionId, -1)

end

--**********************************

--列举事件

--**********************************
--5	非循环任务	未接	1
--6	非循环/循环任务	未完成	2
--7	非循环任务	已完成	3
function x300782_ProcEnumEvent(sceneId, selfId, targetId, MissionId)
	--x300782_LoadAllSubMission()
	if GetLevel(sceneId, selfId) < x300782_g_LevelLess then
		return
	end
	local haveSubMissionId = x300782_HaveWhichSubMission(sceneId, selfId)
	local misIndex = GetQuestIndexByID( sceneId, selfId, haveSubMissionId )
	local missionType,nIndex = x300782_GetMissionInfo(haveSubMissionId)
	if missionType == x300782_g_MissionType.PostMail and GetQuestParam( sceneId, selfId, misIndex, 7 ) ~= 1 then
		return
	end
	local haveDoneMissionId = -1
	local state = 8
	if haveSubMissionId > 0 then
		haveDoneMissionId = x300782_HaveDoneWhichSubMission(sceneId, selfId, targetId)
	end

	if haveDoneMissionId > 0 then
		state = 7
		local missionType,nIndex = x300782_GetMissionInfo(haveDoneMissionId)
		if missionType ~= x300782_g_MissionType.PostMail then
			--return
		end
	elseif haveSubMissionId > 0 then
		state = 6
		return
	end
	AddQuestNumText(sceneId, x300782_g_MissionId, x300782_g_MissionName, state, -1)

end



--**********************************

--检测接受条件

--**********************************

function x300782_ProcAcceptCheck(sceneId, selfId, NPCId)

	--if HasTeam(sceneId, selfId) == 1 then
		return 1
	--end
end


--**********************************

--检测查看条件

--**********************************

function x300782_CheckPushList(sceneId, selfId, NPCId)
	return 1
end

function x300782_DoAccept( sceneId, selfId )
	
	local week = GetWeek()

	if week ~= 3 then
		return "只有周三，才能领取本任务。"
	end

	local bLeader = IsTeamLeader( sceneId, selfId )
	if bLeader ~= 1 then
		return "你不是队长，只有队长才能领取本任务。"
	end
	
	local teamSize = GetTeamSize(sceneId, selfId)
	if (teamSize ~= 2) then
		return "必须组队，而且队伍人数为2人，才能领取本任务。";
	end

	local nearTeamSize = GetNearTeamCount(sceneId, selfId)

	if teamSize ~= nearTeamSize then
		return "很抱歉，所有队员必须都在附近，否则无法接此任务。"
	end

	local targetId = GetNearTeamMember(sceneId, selfId, 0)
	
	if targetId == selfId then
		targetId = GetNearTeamMember(sceneId, selfId, 1)
	end
	
	if IsInDist(sceneId, selfId, targetId, 30) ~= 1 then
		return "很抱歉，所有队员必须都在附近，否则无法接此任务。"
	end

	if IsFriend(sceneId, selfId, targetId) ~= 1 then
		return "很抱歉，你与队伍中成员不是好友关系，无法接此任务。";
	end
	
	if IsFriend(sceneId, targetId, selfId ) ~= 1 then
		return "很抱歉，队伍中成员与你不是好友关系，无法接此任务。";
	end
	
	for i = 0, teamSize - 1 do
		local targetId = GetNearTeamMember(sceneId, selfId, i)
		local targetLevel = GetLevel(sceneId, targetId)
		if targetLevel < 20 then
			return "你的队伍中有人不足20级，无法领取本任务。"
		end
	end

	if GetFriendPoint(sceneId, selfId, targetId) < x300782_g_NeedFriendpoint then
		return format("你与好友的好友度低于%d点，无法领取本任务。",x300782_g_NeedFriendpoint)
	end
	
	if GetFriendPoint(sceneId, targetId, selfId ) < x300782_g_NeedFriendpoint then
		return format("你的好友与你的好友度低于%d点，无法领取本任务。",x300782_g_NeedFriendpoint)
	end
	
	if x300782_GetMissionTimes(sceneId, selfId) >= x300782_g_LimitTimes then
		return format("你已经做过%d次了，无法领取本任务。",x300782_g_LimitTimes)
	end
	
	if x300782_GetMissionTimes(sceneId, targetId) >= x300782_g_LimitTimes then
		return format("你的队友已经做过%d次了，无法领取本任务。",x300782_g_LimitTimes)
	end
	
	if 0 == x300782_CheckFriendTimes(sceneId, selfId, GetGUID(sceneId, targetId)) then
		return "你今天与此好友已经做过一次了，请与其它好友来领取本任务。"
	end
	
	if 0 == x300782_CheckFriendTimes(sceneId, targetId, GetGUID(sceneId, selfId)) then
		return "此好友今天与你已经做过一次了，无法领取本任务。"
	end
	
	local bHaveMission = x300782_IsHaveSubMission(sceneId, selfId)
	if bHaveMission == 1 then
		return "你已经接取了本任务，快去完成吧。"
	end

	for i = 0, teamSize - 1 do
		local targetId = GetNearTeamMember(sceneId, selfId, i)
		local bHaveMission = x300782_IsHaveSubMission(sceneId, targetId)
		if bHaveMission == 1 then
			return "你队伍中有人有本任务，无法接取本任务。"
		end
	end

	for i = 0, teamSize - 1 do
		local targetId = GetNearTeamMember(sceneId, selfId, i)
		if IsQuestFullNM(sceneId, targetId) == 1 then
			return "很抱歉，你队伍中有人任务已经满了，无法领取本任务。"
		end
	end

	for i = 0, teamSize - 1 do
		local targetId = GetNearTeamMember(sceneId, selfId, i)
		if IsQuestFullNM(sceneId, targetId) == 1 then
			return "很抱歉，你队伍中有人任务已经满了，无法领取本任务。"
		end
	end
	
	if IsPlayerStateNormal(sceneId, selfId) <= 0 or GetHp(sceneId, selfId) <= 0 then
		return "你的当前状态无法进行此任务。"
	end
	
	if IsPlayerStateNormal(sceneId, targetId) <= 0 or GetHp(sceneId, targetId) <= 0 then
		return "你好友的当前状态无法进行此任务。"
	end
	
	local nMissionId = x300782_RandomMission(sceneId, selfId, targetId)
	if nMissionId == nil then
		return "随机选择任务出错。"
	end

	local missionType,nIndex = x300782_GetMissionInfo(nMissionId)
	local itemId = 0
	if missionType == x300782_g_MissionType.UseItem then
		itemId = x300782_g_UseItem[nIndex].item
		BeginAddItem(sceneId)
	  AddItem( sceneId, itemId, 1 )
	  local ret = EndAddItem(sceneId,selfId)
	  if ret <= 0 then
	  		return "你物品栏已满，请整理。"
	  end
	  BeginAddItem(sceneId)
	  AddItem( sceneId, itemId, 1 )
	  ret = EndAddItem(sceneId,targetId)
	  if ret <= 0 then
	  		return "你队友物品栏已满，请整理。"
	  end
	elseif missionType == x300782_g_MissionType.PostMail then
		itemId = x300782_g_PostMail[nIndex].item
		BeginAddItem(sceneId)
	  AddItem( sceneId, itemId, 1 )
	  local ret = EndAddItem(sceneId,selfId)
	  if ret <= 0 then
	  		return "你物品栏已满，请整理。"
	  end
	  BeginAddItem(sceneId)
	  AddItem( sceneId, itemId, 1 )
	  ret = EndAddItem(sceneId,targetId)
	  if ret <= 0 then
	  		return "你队友物品栏已满，请整理。"
	  end
	  AddItemListToPlayer(sceneId,selfId)
	  AddItemListToPlayer(sceneId,targetId)
	end

	for i = 0, teamSize - 1 do
		local aId = GetNearTeamMember(sceneId, selfId, i)
		local aName = GetName(sceneId, aId)

		local str = format("你领取了任务:%s", x300782_g_MissionName)
		Msg2Player(sceneId,aId,str,8,2)
		BeginQuestEvent(sceneId);
		AddQuestText(sceneId, str);
		EndQuestEvent();
		DispatchQuestTips(sceneId, aId);
		
		local errorCode
		if missionType == x300782_g_MissionType.PostMail then
			errorCode = AddQuest( sceneId, aId, nMissionId, x300782_g_ScriptId, 1, 1, 1, 1 )
		else
			errorCode = AddQuestNM(sceneId, aId, nMissionId)
		end
		if errorCode ~= 1 then
			Msg2Player(sceneId,aId,"添加任务失败！",8,2)
		end
		
		QuestCom(sceneId,aId,x300782_g_MissionId)
	end
	
	SetFriendPoint(sceneId, selfId, targetId, GetFriendPoint(sceneId, selfId, targetId) - x300782_g_NeedFriendpoint)
	SetFriendPoint(sceneId, targetId, selfId, GetFriendPoint(sceneId, targetId, selfId) - x300782_g_NeedFriendpoint)
	x300782_SetFriendGUID(sceneId, selfId, GetGUID(sceneId, targetId))
	x300782_SetFriendGUID(sceneId, targetId, GetGUID(sceneId, selfId))
	return nil
end

--**********************************

--接受

--**********************************
function x300782_ProcQuestAccept( sceneId, selfId, targetId, MissionId )
	local str = x300782_DoAccept( sceneId, selfId )
	if str ~= nil then
			Msg2Player(sceneId,selfId,str,8,2)
			BeginQuestEvent(sceneId);
			AddQuestText(sceneId, str);
			EndQuestEvent();
			DispatchQuestTips(sceneId, selfId);
	else
			MissionId = x300782_HaveWhichSubMission(sceneId, selfId)
			BeginQuestEvent( sceneId)
		-- 任务名称
			AddQuestText( sceneId, "#Y"..x300782_g_MissionName)
		--任务描述
			AddQuestText( sceneId, GetQuestDescNM (sceneId, selfId, MissionId))
			AddQuestText( sceneId, "#Y任务目标:\r" )
		--任务目标
			local szTarget1,szTarget2,szTarget3,szTarget4,szTarget5 = GetQuestTargetNM(sceneId, selfId, MissionId)
			if (szTarget1 ~= "") then
				AddQuestText( sceneId, szTarget1 )
			end
			local friendshipLevel = GetFriendshipLevelByGuid(sceneId, selfId, x300782_GetFriendGUID(sceneId, selfId))
			local selfLevel = GetLevel(sceneId, selfId)
			local exp = x300782_CalculateExp(friendshipLevel,selfLevel)
			local szAward = "\n#Y奖励内容：\n#W经验值:"..exp.."点"
			AddQuestText( sceneId, szAward )
			EndQuestEvent()
		       
			DispatchQuestInfoNM( sceneId, selfId, targetId, x300782_g_ScriptId, MissionId, 1)

			local other = GetNearTeamMember(sceneId, selfId, 0)
			if other == selfId then
				other = GetNearTeamMember(sceneId, selfId, 1)
			end
			BeginQuestEvent( sceneId)
		-- 任务名称
			AddQuestText( sceneId, "#Y"..x300782_g_MissionName)
		--任务描述
			AddQuestText( sceneId, GetQuestDescNM (sceneId, other, MissionId))
			AddQuestText( sceneId, "#Y任务目标:\r" )
		--任务目标
			local szTarget1,szTarget2,szTarget3,szTarget4,szTarget5 = GetQuestTargetNM(sceneId, other, MissionId)
			if (szTarget1 ~= "") then
				AddQuestText( sceneId, szTarget1 )
			end
			local friendshipLevel = GetFriendshipLevelByGuid(sceneId, other, x300782_GetFriendGUID(sceneId, other))
			local selfLevel = GetLevel(sceneId, other)
			local exp = x300782_CalculateExp(friendshipLevel,selfLevel)
			local szAward = "\n#Y奖励内容：\n#W经验值:"..exp.."点"
			AddQuestText( sceneId, szAward )
			EndQuestEvent()
			DispatchQuestInfoNM( sceneId, other, targetId, x300782_g_ScriptId, MissionId, 1)
	end

end



--**********************************

--放弃

--**********************************

function x300782_ProcQuestAbandon(sceneId, selfId, MissionId)

	local MissionId = x300782_HaveWhichSubMission(sceneId, selfId)
	local missionType,nIndex = x300782_GetMissionInfo(MissionId)
	if missionType == x300782_g_MissionType.PostMail then
		local itemId = x300782_g_PostMail[nIndex].item
		DelItem(sceneId, selfId, itemId, 1)
	end
	
	x300782_UpdateTimes(sceneId, selfId)
	x300782_DeleteAllSubMission( sceneId, selfId )
	QuestUnCom(sceneId,selfId,x300782_g_MissionId)

	--local MissionName = GetQuestNameNM( sceneId, selfId, MissionId )
	local message = "你放弃了任务：【好友】肝胆相照。";
	BeginQuestEvent(sceneId);
		AddQuestText(sceneId, message);
	EndQuestEvent();
	DispatchQuestTips(sceneId, selfId);
	Msg2Player(sceneId, selfId, message, 4, 2);
end



--**********************************

--检测是否可以提交

--**********************************

function x300782_CheckSubmit( sceneId, selfId, MissionId )
	local haveSubMissionId = x300782_HaveWhichSubMission(sceneId, selfId)
	local haveDoneMissionId = -1
	if haveSubMissionId > 0 then
		haveDoneMissionId = x300782_HaveDoneWhichSubMission(sceneId, selfId, 1)
	end

	if haveDoneMissionId > 0 then
		return 1;
	end
	return 0
end

--**********************************

--提交

--**********************************
function x300782_ProcQuestSubmit( sceneId, selfId, targetId, selectId, MissionId )
	local haveSubMissionId = x300782_HaveWhichSubMission(sceneId, selfId)
	local haveDoneMissionId = -1
	if haveSubMissionId > 0 then
		haveDoneMissionId = x300782_HaveDoneWhichSubMission(sceneId, selfId, 1)
	end

	if haveDoneMissionId == nil or haveDoneMissionId < 0 then
        return 0
    end

    if IsHaveQuestNM( sceneId,selfId,haveDoneMissionId )<= 0 then
        return 0
    end
	local ret = x300782_IsFriendCompleteMission(sceneId, selfId, targetId)
	if ret ~= nil then
		Msg2Player(sceneId,selfId,ret,8,2)
		BeginQuestEvent(sceneId);
		AddQuestText(sceneId, ret);
		EndQuestEvent();
		DispatchQuestTips(sceneId, selfId);
		return
	end
	
	ret = QuestComplateNM( sceneId, selfId, targetId, haveDoneMissionId, selectId ) -- 获取完成任务信息
	local misIndex = GetQuestIndexByID( sceneId, selfId, haveDoneMissionId )
	if ret > 0 or GetQuestParam( sceneId, selfId, misIndex, 7 ) == 1 then -- 如果成功完成
		local friendId = GetNearTeamMember(sceneId, selfId, 0)
		if friendId == selfId then
			friendId = GetNearTeamMember(sceneId, selfId, 1)
		end
		
		local missionType,nIndex = x300782_GetMissionInfo(haveDoneMissionId)
		if missionType == x300782_g_MissionType.PostMail then
			local itemId = x300782_g_PostMail[nIndex].item
			DelItem(sceneId, selfId, itemId, 1)
			DelItem(sceneId, friendId, itemId, 1)
		end
		
		x300782_UpdateTimes(sceneId, selfId)
		x300782_UpdateTimes(sceneId, friendId)
		if GetQuestData(sceneId, selfId, MD_FRIEND_COMPLETE_TIMES[1], MD_FRIEND_COMPLETE_TIMES[2], MD_FRIEND_COMPLETE_TIMES[3]) <= x300782_g_MaxTimes then
			local friendshipLevel = GetFriendshipLevel(sceneId, selfId, friendId)
			local selfLevel = GetLevel(sceneId, selfId)
			local exp = x300782_CalculateExp(friendshipLevel,selfLevel)
			AddExp(sceneId, selfId, exp);
			local comMsg = "你完成了任务:【好友】肝胆相照"
			local msg = comMsg.."\n获得#R经验"..exp.."点#cEFC800的奖励"
			Msg2Player(sceneId,selfId,msg,8,2)
			BeginQuestEvent(sceneId);
			AddQuestText(sceneId, comMsg);
			EndQuestEvent();
			DispatchQuestTips(sceneId, selfId);
		else
			local msg = "你完成了任务:【好友】肝胆相照，本日完成的次数超过10次，不能得到任何奖励。"
			Msg2Player(sceneId,selfId,msg,8,2)
			BeginQuestEvent(sceneId);
			AddQuestText(sceneId, msg);
			EndQuestEvent();
			DispatchQuestTips(sceneId, selfId);
		end

		DelQuestNM( sceneId, selfId, haveDoneMissionId )
		QuestUnCom(sceneId,selfId,x300782_g_MissionId)

		if GetQuestData(sceneId, friendId, MD_FRIEND_COMPLETE_TIMES[1], MD_FRIEND_COMPLETE_TIMES[2], MD_FRIEND_COMPLETE_TIMES[3]) < x300782_g_MaxTimes then
			local friendshipLevel = GetFriendshipLevel(sceneId, friendId, selfId )
			local friendLevel = GetLevel(sceneId, friendId)
			local exp = x300782_CalculateExp(friendshipLevel,friendLevel)
			AddExp(sceneId, friendId, exp);
			local comMsg = "你完成了任务:【好友】肝胆相照"
			local msg = comMsg.."\n获得#R经验"..exp.."点#cEFC800的奖励"
			Msg2Player(sceneId,friendId,msg,8,2)
			BeginQuestEvent(sceneId);
			AddQuestText(sceneId, comMsg);
			EndQuestEvent();
			DispatchQuestTips(sceneId, friendId);
		else
			local msg = "你完成了任务:【好友】肝胆相照，本日完成的次数超过10次，不能得到任何奖励。"
			Msg2Player(sceneId,friendId,msg,8,2)
			BeginQuestEvent(sceneId);
			AddQuestText(sceneId, msg);
			EndQuestEvent();
			DispatchQuestTips(sceneId, friendId);
		end
		
		DelQuestNM( sceneId, friendId, haveDoneMissionId )
		QuestUnCom(sceneId, friendId, x300782_g_MissionId)
	end

	return 0

end

function x300782_CalculateExp(friendshipLevel, playerLevel)
	if 1 == friendshipLevel then
		return playerLevel*2000
	elseif 2 == friendshipLevel then
		return playerLevel*2200
	elseif 3 == friendshipLevel then
		return playerLevel*2500
	elseif 4 == friendshipLevel then
		return playerLevel*2800
	elseif 5 == friendshipLevel then
		return playerLevel*3200
	elseif 6 == friendshipLevel then
		return playerLevel*3600
	elseif 7 == friendshipLevel then
		return playerLevel*4000
	elseif 8 == friendshipLevel then
		return playerLevel*4500
	elseif 9 == friendshipLevel then
		return playerLevel*5000
	elseif 10 == friendshipLevel then
		return playerLevel*5500
	end
	return 0
end

--**********************************

--杀死怪物或玩家

--**********************************
function x300782_GetKillMonsterTableIndex(MissionId)
	local index = 1
	for i, MonsterTable in x300782_g_KillMonster do
		if MonsterTable.missionId == MissionId then
			return index
		end
		index = index + 1
	end
	return -1
end

function x300782_GetPostMailTableIndex(MissionId)
	local index = 1
	for i, PostMailTable in x300782_g_PostMail do
		if PostMailTable.missionId == MissionId then
			return index
		end
		index = index + 1
	end
	return -1
end

function x300782_ProcQuestObjectKilled(sceneId, selfId, objdataId, objId, MissionId)
	x300782_OnDie(sceneId, selfId, objdataId, objId, MissionId)
end

--杀死怪物
function x300782_OnDie( sceneId, selfId, objdataId, objId, MissionId )
	local killerType = GetObjType(sceneId, selfId)

	--宠物杀的，记主人身上
	if killerType == 3 then
		selfId = GetOwnerID(sceneId, selfId)
	end	
	
	if IsPlayerStateNormal(sceneId, selfId) ~= 1 then
  	return -1
  end
  
  local mission = x300782_HaveWhichSubMission(sceneId, selfId)
  if mission == -1 then
  	return -1
  end
  
  local missionType,nIndex = x300782_GetMissionInfo(mission)
  if missionType ~= x300782_g_MissionType.KillMonster then
		return -1
	end
	
	if IsQuestHaveDoneNM( sceneId, selfId, mission ) > 0 then --任务已经完成
		return -1
	end

	local KillMonsterTableIndex = x300782_GetKillMonsterTableIndex(mission)
	if KillMonsterTableIndex < 0 then
		return -1
	end
	if GetMonsterDataID(sceneId, objId) ~= x300782_g_KillMonster[KillMonsterTableIndex].monsterDataId then
		return -1
	end
	
	local retCode = x300782_IsFriendHere(sceneId, selfId)
	if retCode ~= nil then
			BeginQuestEvent(sceneId)
			AddQuestText(sceneId, retCode)
			DispatchQuestTips(sceneId, selfId)
			EndQuestEvent(sceneId)
			return -1
	end
	
	local needKillNum = x300782_g_KillMonster[nIndex].num
	local misIndex = GetQuestIndexByID( sceneId, selfId, mission )
	local curKillNum = GetQuestParam( sceneId, selfId, misIndex, 0 )
	
	if curKillNum < needKillNum then
		SetQuestByIndex(sceneId, selfId, misIndex, 0, curKillNum+1);
		local str = ""
		if curKillNum == needKillNum - 1 then
			--完成了～～
			str = format( "#G%s#Y：已经击败: %d/%d个怪物", x300782_g_MissionName, curKillNum+1, needKillNum )
			SetQuestByIndex( sceneId, selfId, misIndex, 7, 1 )
		else
			str = format( "#G%s#Y：已经击败: %d/%d个怪物", x300782_g_MissionName, curKillNum+1, needKillNum )
		end
		BeginQuestEvent(sceneId)
		AddQuestText( sceneId, str )
    EndQuestEvent( sceneId )
    DispatchQuestTips( sceneId, selfId )
	end
	
	local targetId = GetNearTeamMember(sceneId, selfId, 0)
	
	if targetId == selfId then
		targetId = GetNearTeamMember(sceneId, selfId, 1)
	end
	
	misIndex = GetQuestIndexByID( sceneId, targetId, mission )
	curKillNum = GetQuestParam( sceneId, targetId, misIndex, 0 )
	
	if curKillNum < needKillNum then
		SetQuestByIndex(sceneId, targetId, misIndex, 0, curKillNum+1);
		
		local str = ""
		if curKillNum == needKillNum - 1 then
			--完成了～～
			str = format( "#G%s#Y：已经击败: %d/%d个怪物", x300782_g_MissionName, curKillNum+1, needKillNum )
			SetQuestByIndex( sceneId, targetId, misIndex, 7, 1 )
		else
			str = format( "#G%s#Y：已经击败: %d/%d个怪物", x300782_g_MissionName, curKillNum+1, needKillNum )
		end
		BeginQuestEvent(sceneId)
		AddQuestText( sceneId, str )
    EndQuestEvent( sceneId )
    DispatchQuestTips( sceneId, targetId )
	end
	return 1
end

--**********************************

--进入区域事件

--**********************************

function x300782_ProcAreaEntered(sceneId, selfId, zoneId, MissionId)


end

function x300782_ProcTiming(sceneId, selfId )


end

function x300782_ProcAreaLeaved(sceneId, selfId, ScriptId, MissionId )

end



--**********************************

--道具改变

--**********************************
function x300782_ProcQuestItemChanged(sceneId, selfId, itemdataId, MissionId, nChangeType)
end

function x300782_PositionUseItem( sceneId, selfId, BagIndex, impactId )

	local missionId = x300782_HaveWhichSubMission(sceneId, selfId)
	if missionId == -1 then
		return 0
	end
	local missionType,nIndex = x300782_GetMissionInfo(missionId)
	if missionType ~= x300782_g_MissionType.UseItem then
		return 0
	end

	local misIndex = GetQuestIndexByID( sceneId, selfId, missionId )
	if GetQuestParam( sceneId, selfId, misIndex, 1 ) == 1 then
		return 0
	end

	local isScene = 0
	for i, scene in x300782_g_UseItem[nIndex].scene do
		if scene == sceneId then
			isScene = 1
		end
	end

	if isScene ~= 1 then
		return 0
	end

	local scene = x300782_g_UseItem[nIndex].scene[GetCurCountry(sceneId, selfId)+1]
	local posx = x300782_g_UseItem[nIndex].posX
	local posz = x300782_g_UseItem[nIndex].posZ
	local radii = 10

	if posx > 0 then --需要检查地点
		local PlayerPosX,PlayerPosZ = GetWorldPos( sceneId, selfId )

		local distanceRet = radii * radii - (posx - PlayerPosX) * (posx - PlayerPosX) - (posz - PlayerPosZ) * (posz - PlayerPosZ)
		if distanceRet <= 0 then
			local strText = format("很抱歉，这里不能使用该物品，请到@sceneid_%d(%d,%d)处使用!", scene, posx, posz )
			BeginQuestEvent(sceneId)
			AddQuestText(sceneId, strText)
			EndQuestEvent(sceneId)
			DispatchQuestTips(sceneId, selfId)
			return 0
		end
	end

	local retCode = x300782_IsFriendHere(sceneId, selfId)
	if retCode ~= nil then
			BeginQuestEvent(sceneId)
			AddQuestText(sceneId, retCode)
			DispatchQuestTips(sceneId, selfId)
			EndQuestEvent(sceneId)
			return
	end

	BeginQuestEvent(sceneId)
	AddQuestText(sceneId, "象征友谊的烟花绽放在天空中")
	EndQuestEvent(sceneId)
	DispatchQuestTips(sceneId, selfId)

	--删除物品
	EraseItem(sceneId, selfId, BagIndex)

	--播放效果
	if impactId ~= -1 then
		SendSpecificImpactToUnit(sceneId, selfId, selfId, selfId, impactId, 0);
	end
	SetQuestByIndex( sceneId, selfId, misIndex, 0, 1 )
	SetQuestByIndex( sceneId, selfId, misIndex, 7, 1 )

	--x300782_QuestLogRefresh(sceneId, selfId, missionId)
	return 1

end

function x300782_ProcQuestAttach( sceneId, selfId, targetId, npcGuid, misIndex, MissionId )
	MissionId = x300782_HaveWhichSubMission(sceneId, selfId)
	if MissionId == -1 then
		return
	end
	if IsHaveQuestNM( sceneId, selfId, MissionId ) == 0 then	-- 如果没有这个任务
		return
	end
	if GetQuestParam( sceneId, selfId, misIndex, 7 ) == 1 then
		return
	end
	local missionType,nIndex = x300782_GetMissionInfo(MissionId)
	if missionType == x300782_g_MissionType.PostMail then
	  if x300782_g_PostMail[nIndex].npcGuid == npcGuid then
	  	local  missionState = GetQuestStateNM(sceneId, selfId, targetId, MissionId)
	  	AddQuestTextNM( sceneId, selfId, targetId, MissionId, missionState, -1 ) -- 显示任务信息
	  end
	end

end

function x300782_OnOpenItemBox( sceneId, selfId, targetId, gpType, needItemID )
	local MissionId, needItemCount, collNum = GetItemIdInItemBoxNM( sceneId, selfId, targetId, gpType, needItemID )
	if MissionId == -1 then
		return 1 --没有这个任务
	end

	--如果该任务已经完成直接退出
	if IsQuestHaveDoneNM( sceneId, selfId, MissionId ) > 0 then --任务已经完成
		return 1
	end

	if IsHaveQuestNM( sceneId, selfId, MissionId ) == 0 then	-- 如果没这个任务直接退出
		local MissionName = GetQuestNameNM(sceneId, selfId, MissionId)
		local str = "#cffcf00你没有接受相关任务！"
		if MissionName == nil or MissionName == "" then
			str = "#cffcf00你没有接受相关任务！"
		else
			str = format("#cffcf00你没有接受%s！", MissionName);
		end
		BeginQuestEvent(sceneId)
		AddQuestText(sceneId,str)
		EndQuestEvent(sceneId)
		DispatchQuestTips(sceneId,selfId)
		return 1
	end

	local itemCountNow = GetItemCount( sceneId, selfId, needItemID )
	if itemCountNow >= needItemCount then
		local str = "#cffcf00物品已经收集齐全！"
		if needItemCount > 0 then	
			str = "#cffcf00物品已经收集齐全！";
		else
			str = "#cffcf00你不需要这个物品！";
		end
		BeginQuestEvent(sceneId)
		AddQuestText(sceneId,str)
		EndQuestEvent(sceneId)
		DispatchQuestTips(sceneId,selfId)
		return 1
	end
	
	local retCode = x300782_IsFriendHere(sceneId, selfId)
	if retCode ~= nil then
			BeginQuestEvent(sceneId)
			AddQuestText(sceneId, retCode)
			DispatchQuestTips(sceneId, selfId)
			EndQuestEvent(sceneId)
			return 1
	end
	
	return 0
end

function x300782_OnRecycle( sceneId, selfId, targetId, gpType, needItemID )
	local MissionId, needItemCount, collNum = GetItemIdInItemBoxNM( sceneId, selfId, targetId, gpType, needItemID )
	if MissionId == -1 then
		return 1 --没有这个任务
	end

	--如果该任务已经完成直接退出
	if IsQuestHaveDoneNM( sceneId, selfId, MissionId ) > 0 then --任务已经完成
		return 0
	end

	if IsHaveQuestNM( sceneId, selfId, MissionId ) == 0 then	-- 如果没这个任务直接退出
		return 0
	end

	local itemCountNow = GetItemCount( sceneId, selfId, needItemID )
	if itemCountNow >= needItemCount then
		BeginQuestEvent(sceneId)
		AddQuestText(sceneId,"#cffcf00物品已经收集齐全")
		EndQuestEvent(sceneId)
		DispatchQuestTips(sceneId,selfId)
		return 0
	end

	--决定一次采集多少
	local itemAdd = needItemCount - itemCountNow
	if collNum == -1 then
		itemAdd = 1
	else
		if itemAdd > collNum then
			itemAdd = collNum
		end
	end
	if itemAdd > 1 then
		itemAdd = random(itemAdd)
		if itemAdd == 0 then
			itemAdd = 1
		end
	end

	BeginAddItem( sceneId )
	AddItem( sceneId, needItemID, itemAdd )
	local ret = EndAddItem( sceneId, selfId )
	if ret > 0 then
		AddItemListToPlayer(sceneId,selfId)
		local misIndex = GetQuestIndexByID( sceneId, selfId, MissionId )
		SetQuestByIndex( sceneId, selfId, misIndex, 7, 1 )
		x300782_QuestLogRefresh( sceneId, selfId, MissionId)
		return 1
	else
		BeginQuestEvent(sceneId)
		AddQuestText(sceneId,"#cffcf00无法得到采集物品，请整理道具栏！")
		EndQuestEvent(sceneId)
		DispatchQuestTips(sceneId,selfId)
		return 0
	end
	--return CallScriptFunction( MISSION_SCRIPT, "OnRecycle",sceneId, selfId, targetId, gpType, needItemID)
end

function x300782_OnProcOver( sceneId, selfId, targetId, gpType, needItemID )
	return CallScriptFunction( MISSION_SCRIPT, "OnProcOver",sceneId, selfId, targetId)
end

function x300782_OpenCheck( sceneId, selfId, targetId )
	CallScriptFunction( MISSION_SCRIPT, "OpenCheck", sceneId, selfId, targetId )
end


function x300782_GetMissionHelp(sceneId, selfId)
	local subMission = x300782_HaveWhichSubMission(sceneId, selfId)
	local szMissionHelp = ""
	return szMissionHelp
end

function x300782_GetMissionTarget(sceneId, selfId)
	local subMission = x300782_HaveWhichSubMission(sceneId, selfId)
	local szMissionTarget = ""
	return szMissionTarget
end

function x300782_QuestLogRefresh( sceneId, selfId, MissionId)
	MissionId = x300782_HaveWhichSubMission(sceneId, selfId)
	local misIndex = GetQuestIndexByID( sceneId, selfId, MissionId )
	local subMission = x300782_HaveWhichSubMission(sceneId, selfId)
	local szMissionDesc = ""
	local szMissionTarget = ""
	local szMissionNPC = ""
	local szMissionHelp = "" --GetQuestManualNM(sceneId, selfId, misIndex)

	local szTarget1,szTarget2,szTarget3,szTarget4,szTarget5 = GetQuestTargetNM(sceneId, selfId, MissionId)
	local curNum = GetQuestParam( sceneId, selfId, misIndex, 0 )
	local missionType,nIndex = x300782_GetMissionInfo(MissionId)
	if missionType == x300782_g_MissionType.PostMail then
			local PostMailIndex = x300782_GetPostMailTableIndex(MissionId)
			szTarget1 = format("  找到@npc_%s",tostring(x300782_g_PostMail[PostMailIndex].npcGuid))
			szMissionTarget = szTarget1.." ： "..curNum.." / 1"
	end
	
	local missionType,nIndex = x300782_GetMissionInfo(MissionId)
	local itemId = 0
	if missionType == x300782_g_MissionType.PostMail then
		if GetQuestParam( sceneId, selfId, misIndex, 7 ) == 1  then
			szMissionNPC = "@npc_" .. x300782_g_SubmitNPC
		end
	end
	
	
	
	local friendshipLevel = GetFriendshipLevelByGuid(sceneId, selfId, x300782_GetFriendGUID(sceneId, selfId))
	local selfLevel = GetLevel(sceneId, selfId)
	local exp = x300782_CalculateExp(friendshipLevel,selfLevel)
	local szAward = "\t你应该与你的好友（与你一同领取任务的好友）在组队状态下一起完成本任务，在任务过程中如果有任何一人放弃任务，任务将不能完成，另一人必须手动删除。\n#W\n#Y奖励内容：\n#W经验值:"..exp.."点"
	BeginQuestEvent(sceneId)		
	AddQuestLogCustomText( sceneId,
							"",						-- 标题
							"",        -- 任务名字
							szMissionTarget,		--任务目标
							"@npc_" .. x300782_g_SubmitNPC,			--任务NPC
							szAward,               --任务攻略
							"",	--任务描述
							""					--任务小提示
							)
	EndQuestEvent()
	DispatchQuestLogUpdate(sceneId, selfId, subMission);
end

function x300782_ProcQuestLogRefresh( sceneId, selfId, MissionId)
	x300782_QuestLogRefresh( sceneId, selfId, MissionId );
end

function x300782_CheckSubmitNPC( sceneId,selfId,idScript,idMission,npcGUID )
	local missionId = x300782_HaveWhichSubMission(sceneId, selfId)
	if missionId <= 0 then
		return 0
	end
	
	if x300782_g_SubmitNPC == npcGUID then
		return 1
	end

	for i, npcItem in x300782_g_PostMail do
		if npcItem.npcGuid == npcGUID then
			return 1
		end
	end
	
	return 0
end