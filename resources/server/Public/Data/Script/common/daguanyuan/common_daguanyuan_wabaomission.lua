-- 脚本号
x310364_g_ScriptId              = 310364
-- 任务ID
x310364_g_MissionId             = 9060
-- 活动名称
x310364_g_MissionName           = "【个人】挖宝大作战"
-- 玩法最低开放等级
x310364_g_MinLevel              = 85
-- 
x310364_g_strLessMinLevel       = format( "你的等级不到#G%d#cffcc00级，不能参加此活动", x310364_g_MinLevel)
-- 挖宝点配置表
x310364_g_PosTable              = {
                                    { x = 103, z = 118 },  
                                    { x = 150, z = 144 }, 
                                    { x = 143, z = 104 }, 
                                    { x = 181, z = 221 }, 
                                    { x = 201, z = 227 }, 
                                    { x = 204, z = 217 }, 
                                    { x = 160, z = 192 }, 
                                    { x = 133, z = 183 }, 
                                    { x = 85 , z = 193 }, 
                                    { x = 92 , z = 216 }, 
                                    { x = 117, z = 216 }, 
                                    { x = 146, z = 224 }, 
                                    { x = 72 , z = 192 }, 
                                    { x = 43 , z = 202 }, 
                                    { x = 51 , z = 209 }, 
                                    { x = 57 , z = 179 }, 
                                    { x = 64 , z = 118 }, 
                                    { x = 70 , z = 135 }, 
                                    { x = 44 , z = 147 }, 
                                    { x = 87 , z = 52  }, 
                                    { x = 79 , z = 85  }, 
                                    { x = 76 , z = 79  }, 
                                    { x = 168, z = 94  }, 
                                    { x = 158, z = 85  }, 
                                    { x = 170, z = 61  }, 
                                    { x = 187, z = 80  }, 
                                    { x = 168, z = 72  }, 
                                    { x = 212, z = 118 }, 
                                    { x = 223, z = 120 }, 
                                    { x = 209, z = 128 }, 
                                    { x = 226, z = 140 },  
                                    { x = 150, z = 140 }, 
                                    { x = 139, z = 104 }, 
                                    { x = 179, z = 217 }, 
                                    { x = 197, z = 229 }, 
                                    { x = 203, z = 214 },
                                    { x = 156, z = 195 }, 
                                    { x = 136, z = 188 }, 
                                    { x = 119, z = 181 }, 
                                    { x = 87 , z = 202 }, 
                                    { x = 93 , z = 221 }, 
                                    { x = 122, z = 217 }, 
                                    { x = 144, z = 229 }, 
                                    { x = 76 , z = 198 }, 
                                    { x = 46 , z = 196 }, 
                                    { x = 58 , z = 206 }, 
                                    { x = 52 , z = 180 }, 
                                    { x = 65 , z = 123 }, 
                                    { x = 64 , z = 139 }, 
                                    { x = 51 , z = 151 }, 
                                    { x = 85 , z = 59  }, 
                                    { x = 75 , z = 78  }, 
                                    { x = 70 , z = 73  }, 
                                    { x = 169, z = 98  }, 
                                    { x = 161, z = 81  }, 
                                    { x = 174, z = 66  },
                                    { x = 188, z = 84  }, 
                                    { x = 168, z = 68  }, 
                                    { x = 211, z = 114 }, 
                                    { x = 225, z = 123 }, 
                                    { x = 209, z = 126 }, 
                                    { x = 226, z = 142 }, 
                                    { x = 103, z = 112 }, 
                                    { x = 147, z = 137 },  
                                    { x = 177, z = 214 }, 
                                    { x = 184, z = 229 }, 
                                    { x = 204, z = 208 }, 
                                    { x = 154, z = 199 }, 
                                    { x = 141, z = 191 }, 
                                    { x = 88 , z = 207 }, 
                                    { x = 100, z = 219 }, 
                                    { x = 120, z = 213 }, 
                                    { x = 140, z = 227 },
                                    { x = 70 , z = 202 }, 
                                    { x = 43 , z = 193 }, 
                                    { x = 61 , z = 212 }, 
                                    { x = 46 , z = 181 }, 
                                    { x = 72 , z = 126 }, 
                                    { x = 62 , z = 145 }, 
                                    { x = 55 , z = 151 }, 
                                    { x = 78 , z = 53  }, 
                                    { x = 70 , z = 74  }, 
                                    { x = 78 , z = 86  }, 
                                    { x = 163, z = 97  }, 
                                    { x = 168, z = 79  }, 
                                    { x = 177, z = 70  }, 
                                    { x = 193, z = 87  }, 
                                    { x = 169, z = 76  }, 
                                    { x = 211, z = 111 }, 
                                    { x = 225, z = 126 }, 
                                    { x = 207, z = 128 }, 
                                    { x = 224, z = 142 },                                
}
-- 挖掘目标场景ID
x310364_g_TargetSceneId         = 40
-- 
x310364_MP_TARGET1				= 1
x310364_MP_TARGET2				= 2
x310364_MP_TARGET3				= 3
x310364_MP_TARGET4				= 4
x310364_MP_TARGET5				= 5
x310364_MP_TARGET6				= 6
-- 任务目标
x310364_g_MissionTarget			= "  去#aB#h00CCFF{goto_%d,%d,%d}%s(%d,%d)#aE处使用@npcsp_梦聊铁铲_145101或@npcsp_梦聊金铲_145101（高奖）挖宝(%d/20)"
-- 任务信息
x310364_g_MissionInfo			= "去#aB#h00CCFF{goto_%d,%d,%d}%s(%d,%d)#aE处去挖宝吧。"
-- 任务帮助信息
x310364_g_MissionHelp			= "去商人那里买一个铁铲，然后去宝藏所在地使用"
-- 经验获得配置
x310364_g_XPTable               = {
                                    { base = 1728, advanced = 3456, probability = 25 }, 
                                    { base = 5184, advanced = 10368, probability = 25 }, 
}
-- 道具获得配置,probability=n-------n/20000的几率
x310364_g_ItemTable             = {
                                    { 
                                      { id = 11990015, probability = 120, count = 1 }, 
                                      { id = 11990011, probability = 60, count = 1 }, 
                                      { id = 12030016, probability = 40, count = 1 }, 
                                      { id = 11000501, probability = 40, count = 1 }, 
                                      { id = 12240002, probability = 80, count = 1 },
                                      { id = 11000598, probability = 1000, count = 1 } 
                                    },
                                    { 
                                      { id = 11990015, probability = 600, count = 1 }, 
                                      { id = 11990011, probability = 300, count = 1 }, 
                                      { id = 12030016, probability = 200, count = 1 }, 
                                      { id = 11000501, probability = 200, count = 1 }, 
                                      { id = 12240002, probability = 400, count = 1 },
                                      { id = 11000300, probability = 4, count = 1 }, 
                                      { id = 11000547, probability = 600, count = 1 },
                                      { id = 10310026, probability = 1, count = 1 },
                                      { id = 10310025, probability = 1, count = 1 },
                                      { id = 11000598, probability = 2000, count = 1 }                                      
                                    },
}
-- 毒气buffId -
x310364_g_Duqi_BuffID           = 7710
-- 瘴气buffId --
x310364_g_Zhangqi_BuffID        = 7710
-- 迅捷buffId +
x310364_g_Xunjie_BuffID         = 7709
-- 急速buffId++
x310364_g_Jisu_BuffID           = 7709
-- 最大完成时间
x310364_g_MaxFinishTime         = 16000
-- 前20名数据
x310364_g_Top20Player           = {}
-- 称号表
x310364_g_TitleTable            = { 115, 116, 117, 118, 118, 118, 118, 118, 118, 118, 118, 118, 118, 118, 118, 118, 118, 118, 118, 118 }
-- 提交任务经验奖励
x310364_g_finishxp				= 2000
-- open flag
x310364_g_IsEnableId            = 1045
-- reward
x310364_g_RewardTable           = { 11010100, 11010101, 11010102 }

function x310364_ProcEnumEvent( sceneId, selfId, NPCId, MissionId)
    if GetGameOpenById( x310364_g_IsEnableId) <= 0 then
        return
    end

    AddQuestNumText( sceneId, x310364_g_MissionId, x310364_g_MissionName, GetQuestStateNM( sceneId, selfId, NPCId, x310364_g_MissionId), 1)
    AddQuestNumText( sceneId, x310364_g_MissionId, "挖宝大作战排名查询", 3, 2)
    local minute = GetMinOfDay()
    local day, week = GetWeek()
    if ( day == 0 or day == 6) and minute >= 1050 then
        AddQuestNumText( sceneId, x310364_g_MissionId, "领取挖宝大作战奖励", 3, 3)
    end

    -- 时间检查，如果日期或星期变化就清空x310364_g_Top20Player
    local day, week = GetWeek()
    if GetCountryParam( sceneId, 2, CD_PIONEER_FUNS) ~= week then
        x310364_g_Top20Player = {}
        SetCountryParam( sceneId, 2, CD_PIONEER_FUNS, week)
        SetCountryParam( sceneId, 3, CD_PIONEER_FUNS, day)
    else
        if GetCountryParam( sceneId, 3, CD_PIONEER_FUNS) ~= day then
            x310364_g_Top20Player = {}
            SetCountryParam( sceneId, 3, CD_PIONEER_FUNS, day)
        end
    end
end

function x310364_ProcEventEntry( sceneId, selfId, NPCId, idScript, idExt)
    if GetGameOpenById( x310364_g_IsEnableId) <= 0 then
        return
    end

    if idExt == 1 then
        if GetLevel( sceneId, selfId) < x310364_g_MinLevel then
            Msg2Player( sceneId, selfId, x310364_g_strLessMinLevel, 8, 3)
            return
        end

        if IsHaveQuest( sceneId, selfId, x310364_g_MissionId) > 0 then
            local misIndex = GetQuestIndexByID( sceneId, selfId, x310364_g_MissionId)
            if GetQuestParam( sceneId, selfId, misIndex, 0) == 1 and GetQuestParam( sceneId, selfId, misIndex, 7) == 1 then
                x310364_DispatchMissionComplete( sceneId, selfId, NPCId)
            else
                x310364_DispatchMissionContinue( sceneId, selfId, NPCId)
            end
        else
            x310364_DispatchMissionInfo( sceneId, selfId, NPCId)
        end
    elseif idExt == 2 then
        BeginQuestEvent( sceneId)
            AddQuestText( sceneId, "#Y"..x310364_g_MissionName)
            if getn( x310364_g_Top20Player) > 0 then
                AddQuestText( sceneId, "\t排名靠前的玩家有：#r" )
                for i, item in x310364_g_Top20Player do
                    AddQuestText( sceneId, format( "\t#G%s#r", item.name) )
                end
            else
                AddQuestText( sceneId, "\t今天没有玩家完成此任务。" )
            end
        EndQuestEvent()
        DispatchQuestEventList( sceneId, selfId, NPCId)
    elseif idExt == 3 then
        local guid = GetGUID( sceneId, selfId)
        local order = 0
        for i, item in x310364_g_Top20Player do
            if guid == item.guid then
                order = i
                break
            end
        end
        if order == 0 then
            Msg2Player( sceneId, selfId, "很遗憾，你排名没能进入前20名，不能领取奖励", 8, 3)
            return
        else
            BeginQuestEvent( sceneId)
                AddQuestText( sceneId, "#Y"..x310364_g_MissionName)
                AddQuestText( sceneId, format( "#Y本周的挖宝活动你排名第#R%d#W，是否领取奖励？", order) )
            EndQuestEvent()
            DispatchQuestInfo( sceneId, selfId, NPCId, x310364_g_ScriptId, -1)
        end
    end
end

function x310364_ProcAcceptCheck( sceneId, selfId, NPCId)
    if GetGameOpenById( x310364_g_IsEnableId) <= 0 then
        return
    end

    local minute = GetMinOfDay()
    local day, week = GetWeek()
    if ( day == 0 or day == 6) and minute >= 1050 then
        local guid = GetGUID( sceneId, selfId)
        local order = 0
        local getFlag = 0
        for i, item in x310364_g_Top20Player do
            if guid == item.guid then
                order = i
                getFlag = item.getFlag
                break
            end
        end
        if order == 0 then
            Msg2Player( sceneId, selfId, "很遗憾，你排名没能进入前20名，不能领取奖励", 8, 3)
            return 0
        end
        if getFlag == 1 then
            Msg2Player( sceneId, selfId, "你已经领取过了，不能重复领取", 8, 3)
            return 0
        end
        AwardTitle( sceneId, selfId, x310364_g_TitleTable[ order] )
        local exp =1
        if order == 1 then
        	exp =10000000	
        	AddExp( sceneId, selfId, exp)
        	Msg2Player(sceneId, selfId, "#cffcf00恭喜获得#G经验"..exp.."#cffcf00的奖励", 0, 2)
        	Msg2Player(sceneId, selfId, "#cffcf00恭喜获得#G经验"..exp.."#cffcf00的奖励", 0, 3)
        elseif order == 2 then
        	exp =8000000	
        	AddExp( sceneId, selfId, exp)
        	Msg2Player(sceneId, selfId, "#cffcf00恭喜获得#G经验"..exp.."#cffcf00的奖励", 0, 2)
        	Msg2Player(sceneId, selfId, "#cffcf00恭喜获得#G经验"..exp.."#cffcf00的奖励", 0, 3)        	
        elseif order == 3 then
        	exp =5000000	
        	AddExp( sceneId, selfId, exp)
        	Msg2Player(sceneId, selfId, "#cffcf00恭喜获得#G经验"..exp.."#cffcf00的奖励", 0, 2)
        	Msg2Player(sceneId, selfId, "#cffcf00恭喜获得#G经验"..exp.."#cffcf00的奖励", 0, 3)
        elseif order <= 20 then
        	exp =2000000	
        	AddExp( sceneId, selfId, exp)
        	Msg2Player(sceneId, selfId, "#cffcf00恭喜获得#G经验"..exp.."#cffcf00的奖励", 0, 2)
        	Msg2Player(sceneId, selfId, "#cffcf00恭喜获得#G经验"..exp.."#cffcf00的奖励", 0, 3)
        end
        x310364_g_Top20Player[ order].getFlag = 1
    else
        Msg2Player( sceneId, selfId, "很遗憾，领奖时间已过", 8, 3)
        return 0
    end

    return 1
end

function x310364_ProcAccept( sceneId, selfId, NPCId)
end

function x310364_DispatchMissionInfo( sceneId, selfId, NPCId)
    BeginQuestEvent( sceneId)
        AddQuestText( sceneId, "#Y"..x310364_g_MissionName)
        AddQuestText( sceneId, "\t想要参加挖宝大作战吗？请先听我介绍下挖宝大作战：\n\t每周六、日的下午14：00――17：00，每人可以进行两轮挖宝大作战。每轮需要在天上人间・梦聊里面的20个地点使用梦幻铁铲或梦幻金铲进行挖宝，挖宝过程会有各种情况发生，使用梦幻金铲在挖宝过程中的收益高于梦幻铁铲。当天完成任务用时最短的20名玩家会得到额外的奖励，取每天自己最好成绩参与排名。\n \n#G小提示：\n\t梦幻铁铲，梦幻金铲可在任务发布人处购买。#W" )
    EndQuestEvent()
    DispatchQuestInfoNM( sceneId, selfId, NPCId, x310364_g_ScriptId, x310364_g_MissionId)
end

function x310364_DispatchMissionContinue( sceneId, selfId, NPCId)
    BeginQuestEvent( sceneId)
        AddQuestText( sceneId, "#Y"..x310364_g_MissionName)
        AddQuestText( sceneId, "\t没有铲子吗？在我这里就能买到梦聊铁铲、梦聊金铲。使用#G梦聊金铲#W完成任务能获得#G更好的收益#W。\n\t好了，别磨磨蹭蹭的了，任务还在#G计时#W，当天完成任务用时最少的玩家会有特殊称号及#G额外奖励#W！" )
    EndQuestEvent()
    DispatchQuestEventList( sceneId, selfId, NPCId)
end

function x310364_DispatchMissionComplete( sceneId, selfId, NPCId)
		local level = GetLevel( sceneId, selfId)
		local exp = x310364_g_finishxp *level
    BeginQuestEvent( sceneId)
        AddQuestText( sceneId, "#Y"..x310364_g_MissionName)
        AddQuestText( sceneId, "\t这梦幻聊斋的世界里面遍地是宝，通过刚才的挖宝体会到此言不虚了吧。这次你用的时间我已经记录下来了，稍后我会在17：30公布用时最短的20名玩家。" )
        AddQuestText( sceneId, "\n \n#Y任务奖励：")
        AddQuestText( sceneId, "经验值："..exp.."点")
    EndQuestEvent()
    DispatchQuestInfoNM( sceneId, selfId, NPCId, x310364_g_ScriptId, x310364_g_MissionId)
end

function x310364_ProcQuestAccept( sceneId, selfId, NPCId, missionId)
    if GetGameOpenById( x310364_g_IsEnableId) <= 0 then
        return
    end

    local day, week = GetWeek()
    if IsHaveQuest( sceneId, selfId, x310364_g_MissionId) > 0 then
    	if x310364_GetMD( sceneId, selfId, MD_WABAO_WEEK) == week then
            if day == 6 and x310364_GetMD( sceneId, selfId, MD_WABAO_FINISHED) >= 2 then
                return
            end
            if day == 0 and x310364_GetMD( sceneId, selfId, MD_WABAO_TIMES) >= 2 then
                return
            end
        end

        local level = GetLevel( sceneId, selfId)
        local exp = x310364_g_finishxp *level
        local misIndex = GetQuestIndexByID( sceneId, selfId, x310364_g_MissionId)
        local gtime = GetQuestParam( sceneId, selfId, misIndex, x310364_MP_TARGET3)
        AddExp( sceneId, selfId, exp)
        Msg2Player(sceneId, selfId, "您完成了任务"..x310364_g_MissionName.."！", 0, 2)
        Msg2Player(sceneId, selfId, "您完成了任务"..x310364_g_MissionName.."！", 0, 3)
        Msg2Player(sceneId, selfId, "#Y获得#R经验"..exp.."#Y的奖励", 0, 2)			 
        DelQuest( sceneId, selfId, x310364_g_MissionId)
        GamePlayScriptLog(sceneId, selfId, 1672)
        -- 计算完成任务所需时间
        local useTime = GetCurrentTime() - gtime
        local needsort = 1
        local oldTime = x310364_GetMD( sceneId, selfId, MD_WABAO_USETIME)
        if useTime < x310364_g_MaxFinishTime then
            if useTime < oldTime then
                x310364_SetMD( sceneId, selfId, MD_WABAO_USETIME, useTime)
            else
                useTime = oldTime
            end
        end
        if x310364_GetMD( sceneId, selfId, MD_WABAO_WEEK) == week then
            if day == 6 then
                if x310364_GetMD( sceneId, selfId, MD_WABAO_DAYFLAG) == 1 then
                    local times = x310364_GetMD( sceneId, selfId, MD_WABAO_FINISHED) + 1
                    x310364_SetMD( sceneId, selfId, MD_WABAO_FINISHED, times)
                else
                    x310364_SetMD( sceneId, selfId, MD_WABAO_FINISHED, 1)
                     -- 跨天给他算一个很大的完成时间
                    useTime = x310364_g_MaxFinishTime
                    x310364_SetMD( sceneId, selfId, MD_WABAO_USETIME, x310364_g_MaxFinishTime)
                    needsort = 0
                end
            elseif day == 0 then
                if x310364_GetMD( sceneId, selfId, MD_WABAO_DAYFLAG) == 0 then
                    local times = x310364_GetMD( sceneId, selfId, MD_WABAO_TIMES) + 1
                    x310364_SetMD( sceneId, selfId, MD_WABAO_TIMES, times)
                else
                    x310364_SetMD( sceneId, selfId, MD_WABAO_TIMES, 1)
                     -- 跨天给他算一个很大的完成时间
                    useTime = x310364_g_MaxFinishTime
                    x310364_SetMD( sceneId, selfId, MD_WABAO_USETIME, x310364_g_MaxFinishTime)
                    needsort = 0
                end
            end
        else
            -- 如果完成的任务是上周接的
            if day == 6 then
                x310364_SetMD( sceneId, selfId, MD_WABAO_FINISHED, 1)
            end
            if day == 0 then
                x310364_SetMD( sceneId, selfId, MD_WABAO_TIMES, 1)
            end
            -- 给他算一个很大的完成时间
            useTime = x310364_g_MaxFinishTime
            x310364_SetMD( sceneId, selfId, MD_WABAO_USETIME, x310364_g_MaxFinishTime)
            needsort = 0
        end
        if needsort == 1 then
            -- check whether selfId is already in x310364_g_Top20Player
            local b = 0
            local bsort = 1
            for i, item in x310364_g_Top20Player do
                -- 如果已经在全局数组并且这次成绩更好
                if item.guid == GetGUID( sceneId, selfId) then 
                    b = 1
                    if item.costTime > useTime then
                        -- 更新自己的最好成绩
                        item.costTime = useTime
                    end
                    break
                end
            end
            if b == 0 then
                local count = getn( x310364_g_Top20Player)
                if count >= 20 then
                    -- 如果已经取前20名并且比最后一名的成绩好就顶替之
                    if useTime < x310364_g_Top20Player[ 20].costTime then
                        x310364_g_Top20Player[ 20] = { guid = GetGUID( sceneId, selfId), costTime = useTime, name = GetName( sceneId, selfId), getFlag = 0 }
                    else
                        -- 无需排序
                        bsort = 0
                    end
                else
                    x310364_g_Top20Player[ count + 1] = { guid = GetGUID( sceneId, selfId), costTime = useTime, name = GetName( sceneId, selfId), getFlag = 0 }
                end
            end
            if bsort == 1 then
                -- 排序
                sort( x310364_g_Top20Player, function ( a, b) return a.costTime < b.costTime end)
            end
        else
            Msg2Player( sceneId, selfId, "不是当天领取任务无法参加挖宝大作战排名", 8, 3)
        end
        if random( 1, 100) <= 5 then
            BeginAddItem( sceneId)
            AddItem( sceneId, x310364_g_RewardTable[ random( 1, 3) ], 1)
            if EndAddItem( sceneId, selfId) == 0 then
                Msg2Player( sceneId, selfId, "背包已满，无法获得额外奖励物品", 8, 3)
            else
                AddItemListToPlayer( sceneId, selfId)
            end
        end
        x310364_SetMD( sceneId, selfId, MD_WABAO_WEEK, week)
    else
        local minute = GetMinOfDay()
        if minute < 840 or minute > 1020 then
            Msg2Player( sceneId, selfId, "此任务只有周六、日下午#G14：00――17：00#cffcc00可以领取", 8, 3)
            return
        end
        if x310364_GetMD( sceneId, selfId, MD_WABAO_WEEK) == week then
            if day == 6 and x310364_GetMD( sceneId, selfId, MD_WABAO_FINISHED) >= 2 then
                Msg2Player( sceneId, selfId, "今天不能再领取此任务了", 8, 3)
                return
            end
            if day == 0 and x310364_GetMD( sceneId, selfId, MD_WABAO_TIMES) >= 2 then
                Msg2Player( sceneId, selfId, "今天不能再领取此任务了", 8, 3)
                return
            end
        else
            x310364_SetMD( sceneId, selfId, MD_WABAO_WEEK, week)
            x310364_SetMD( sceneId, selfId, MD_WABAO_FINISHED, 0)
            x310364_SetMD( sceneId, selfId, MD_WABAO_TIMES, 0)
            x310364_SetMD( sceneId, selfId, MD_WABAO_DUIHUAN1, 0)
            x310364_SetMD( sceneId, selfId, MD_WABAO_USETIME, x310364_g_MaxFinishTime)
        end
        if AddQuest( sceneId, selfId, x310364_g_MissionId, x310364_g_ScriptId, 0, 0, 0, 0) == 0 then
            Msg2Player( sceneId, selfId, "任务已满，添加任务失败", 8, 3)
            return
        else
        	Msg2Player(sceneId, selfId, "您接受了任务"..x310364_g_MissionName.."！", 0, 2)
		  		Msg2Player(sceneId, selfId, "您接受了任务"..x310364_g_MissionName.."！", 0, 3)    
        end
        if day == 6 then
            x310364_SetMD( sceneId, selfId, MD_WABAO_DAYFLAG, 1)
        elseif day == 0 then
            x310364_SetMD( sceneId, selfId, MD_WABAO_DAYFLAG, 0)
        end
        GamePlayScriptLog(sceneId, selfId, 1671)
        local misIndex = GetQuestIndexByID( sceneId, selfId, x310364_g_MissionId)
        SetQuestByIndex( sceneId, selfId, misIndex, x310364_MP_TARGET1, random( 1, getn( x310364_g_PosTable) ) )
        SetQuestByIndex( sceneId, selfId, misIndex, x310364_MP_TARGET2, 0)
        SetQuestByIndex( sceneId, selfId, misIndex, x310364_MP_TARGET3, floor( GetCurrentTime() ) )
    end
end

function x310364_ProcQuestLogRefresh( sceneId, selfId, MissionId)
    local misIndex = GetQuestIndexByID( sceneId, selfId, x310364_g_MissionId)
    local index = GetQuestParam( sceneId, selfId, misIndex, x310364_MP_TARGET1)
    local times = GetQuestParam( sceneId, selfId, misIndex, x310364_MP_TARGET2)
    local pos = x310364_g_PosTable[ index]

	BeginQuestEvent( sceneId)
        AddQuestLogCustomText( sceneId,
                                "",                             -- 标题
                                x310364_g_MissionName,             -- 任务名字
                                format( x310364_g_MissionTarget, x310364_g_TargetSceneId, pos.x, pos.z, "天上人间・梦聊", pos.x, pos.z, times),
                                "@npc_145101",                             --任务NPC
                                x310364_g_MissionHelp,
                                format( x310364_g_MissionInfo, x310364_g_TargetSceneId, pos.x, pos.z, "天上人间・梦聊", pos.x, pos.z),
                                "" )

	EndQuestEvent()
	DispatchQuestLogUpdate( sceneId, selfId, MissionId)
end

function x310364_ProcUseShovel( sceneId, selfId, gold)
    if IsHaveQuest( sceneId, selfId, x310364_g_MissionId) == 0 then
        return 0
    end

    local misIndex = GetQuestIndexByID( sceneId, selfId, x310364_g_MissionId)
    local index = GetQuestParam( sceneId, selfId, misIndex, x310364_MP_TARGET1)
    local times = GetQuestParam( sceneId, selfId, misIndex, x310364_MP_TARGET2)
    local pos = x310364_g_PosTable[ index]
    local x, z = GetWorldPos( sceneId, selfId)

    if GetQuestParam( sceneId, selfId, misIndex, 0) == 1 and GetQuestParam( sceneId, selfId, misIndex, 7) == 1 then
        Msg2Player( sceneId, selfId, "任务已经完成，不能继续挖掘了", 8, 3)
        return
    end

    if sceneId ~=40 then
        Msg2Player( sceneId, selfId, "道具使用失败，请前往天上人间・梦聊内使用", 8, 2)
        Msg2Player( sceneId, selfId, "道具使用失败，请前往天上人间・梦聊内使用", 8, 3)
        return 0
    end
    
    if pos.x ~= x or pos.z ~= z then
    	Msg2Player( sceneId, selfId, "挖宝地点错误，挖宝失败", 8, 2)
        Msg2Player( sceneId, selfId, "挖宝地点错误，挖宝失败", 8, 3)
        return 0
    end

    if random( 1, 100) <= x310364_g_XPTable[ gold + 1].probability then
        local xp = x310364_g_XPTable[ gold + 1].advanced
        AddExp( sceneId, selfId, xp * GetLevel( sceneId, selfId) )                   
        Msg2Player(sceneId, selfId, "挖宝成功，幸运获得高额经验#R"..xp * GetLevel( sceneId, selfId).."#cffcf00点的奖励", 0, 2)			 
        Msg2Player(sceneId, selfId, "挖宝成功，幸运获得高额经验#R"..xp * GetLevel( sceneId, selfId).."#cffcf00点的奖励", 0, 3)
    else
        local xp = x310364_g_XPTable[ gold + 1].base
        AddExp( sceneId, selfId, xp * GetLevel( sceneId, selfId) )                   
        Msg2Player(sceneId, selfId, "挖宝成功，获得经验#R"..xp * GetLevel( sceneId, selfId).."#cffcf00点的奖励", 0, 2)			 
        Msg2Player(sceneId, selfId, "挖宝成功，获得经验#R"..xp * GetLevel( sceneId, selfId).."#cffcf00点的奖励", 0, 3)
    end

    local allitem = x310364_g_ItemTable[ gold + 1]
    local probability = random( 1, 20000)
    local Min = 1
    local Max = 1
    local item = nil
    local buff 	=	9011
		local buff1 =	9013
		local buff2 =	9012    
    for i, iter in allitem do
        Max = Max + iter.probability
        if probability >= Min and probability < Max then
            item = iter
            break
        end
    end
    if item ~= nil then
        BeginAddItem( sceneId)
        if IsHaveSpecificImpact( sceneId, selfId, buff) == 1 or IsHaveSpecificImpact( sceneId, selfId, buff1) == 1  or IsHaveSpecificImpact( sceneId, selfId, buff2) == 1 then
       		AddItem( sceneId, item.id, item.count)
       	else
       		AddBindItem( sceneId, item.id, item.count)
       	end
       			
        if EndAddItem( sceneId, selfId) == 0 then
            Msg2Player( sceneId, selfId, "背包已满，无法放入挖到的物品", 8, 3)
            return 0
        end
        AddItemListToPlayer( sceneId, selfId)
    elseif probability >=19999 then
        local rx = random( 1, 3)
        local rz = random( 1, 3)
        CreateMonster( sceneId, 17321, x + rx, z + rz, 1, 902, x310364_g_ScriptId, -1, 21, 1000000)
        local name = GetName(sceneId, selfId)
        local msg =format("%s在挖宝过程中，惊动了(%d,%d)附近的伊戈利",name,x,z)
        LuaThisScenceM2Wrold (sceneId, msg, 5, 1)
    elseif probability >= 10001 and probability <= 10800 then		--4%自己减速
        SendSpecificImpactToUnit( sceneId, selfId, selfId, selfId, x310364_g_Duqi_BuffID, 0)   
        Msg2Player(sceneId, selfId, "很不幸，挖宝时铲到了自己的脚，减速5秒。", 0, 2)			 
        Msg2Player(sceneId, selfId, "很不幸，挖宝时铲到了自己的脚，减速5秒。", 0, 3)    		
    elseif probability >= 12001 and probability <= 12600 then			--3%群体减速
        local x, z = GetWorldPos( sceneId, selfId)
        local humancount = GetNearPlayerCount( sceneId, selfId, x, z, 5)
        for	i = 0, humancount - 1 do
            local humanId = GetNearPlayerMember( sceneId, selfId, i)
            if IsPlayerStateNormal( sceneId, humanId) == 1 then
                SendSpecificImpactToUnit( sceneId, humanId, humanId, humanId, x310364_g_Zhangqi_BuffID, 0)
            end
        end
        SendSpecificImpactToUnit( sceneId, selfId, selfId, selfId, x310364_g_Zhangqi_BuffID, 0)
        Msg2Player(sceneId, selfId, "很不幸，挖宝引起阴气外泄，附近人员减速5秒。", 0, 2)			 
        Msg2Player(sceneId, selfId, "很不幸，挖宝引起阴气外泄，附近人员减速5秒。", 0, 3)  
    elseif probability >= 14001 and probability <= 15200 then   	--6%自己加速		
        SendSpecificImpactToUnit( sceneId, selfId, selfId, selfId, x310364_g_Xunjie_BuffID, 0)
        Msg2Player(sceneId, selfId, "挖宝遇到鬼，惊恐之下移动速度上升15秒。", 0, 2)			 
        Msg2Player(sceneId, selfId, "挖宝遇到鬼，惊恐之下移动速度上升15秒。", 0, 3)        			
    elseif probability >= 16001 and probability <= 16400 then     --2%群体加速
        local x, z = GetWorldPos( sceneId, selfId)
        local humancount = GetNearPlayerCount( sceneId, selfId, x, z, 5)
        for	i = 0, humancount - 1 do
            local humanId = GetNearPlayerMember( sceneId, selfId, i)
            if IsPlayerStateNormal( sceneId, humanId) == 1 then
                SendSpecificImpactToUnit( sceneId, humanId, humanId, humanId, x310364_g_Jisu_BuffID, 0)
            end
        end
        SendSpecificImpactToUnit( sceneId, selfId, selfId, selfId, x310364_g_Jisu_BuffID, 0)
        Msg2Player(sceneId, selfId, "挖宝惊动了附近某位仙子，为了赶走众人，附近玩家移动速度上升15秒。", 0, 2)			 
        Msg2Player(sceneId, selfId, "挖宝惊动了附近某位仙子，为了赶走众人，附近玩家移动速度上升15秒。", 0, 3)       		
    end

    SetQuestByIndex( sceneId, selfId, misIndex, x310364_MP_TARGET2, times + 1)
    if ( times + 1) < 20 then
        -- 更新下个挖掘目标
        local newindex = random( 1, getn( x310364_g_PosTable) )
        while newindex == index do
            newindex = random( 1, getn( x310364_g_PosTable) )
        end
        SetQuestByIndex( sceneId, selfId, misIndex, x310364_MP_TARGET1, newindex)
        x310364_ProcQuestLogRefresh( sceneId, selfId, x310364_g_MissionId)
    else
        SetQuestByIndex( sceneId, selfId, misIndex, 0, 1)
        SetQuestByIndex( sceneId, selfId, misIndex, 7, 1)
    end

    return 1
end

function x310364_GetMD( sceneId, selfId, mdName)
    return GetQuestData( sceneId, selfId, mdName[ 1], mdName[ 2], mdName[ 3] )
end

function x310364_SetMD( sceneId, selfId, mdName, value)
    SetQuestData( sceneId, selfId, mdName[ 1], mdName[ 2], mdName[ 3], value)
end

function x310364_ProcQuestAbandon( sceneId, selfId, MissionId)
    DelQuest( sceneId, selfId, x310364_g_MissionId)
    Msg2Player(sceneId, selfId, "您放弃了任务"..x310364_g_MissionName.."！", 0, 2)
		Msg2Player(sceneId, selfId, "您放弃了任务"..x310364_g_MissionName.."！", 0, 3)  
    local day, week = GetWeek()
    if day == 6 then
        local times = x310364_GetMD( sceneId, selfId, MD_WABAO_FINISHED)
        x310364_SetMD( sceneId, selfId, MD_WABAO_FINISHED, times + 1)
    end
    if day == 0 then
        local times = x310364_GetMD( sceneId, selfId, MD_WABAO_TIMES)
        x310364_SetMD( sceneId, selfId, MD_WABAO_TIMES, times + 1)
    end
end



function x310364_OnDie(sceneId, selfId, killerId)
	GamePlayScriptLog(sceneId, killerId, 1673)
end










