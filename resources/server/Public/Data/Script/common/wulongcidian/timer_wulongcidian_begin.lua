--脚本号
x310185_g_ScriptId = 310185

x310185_g_CreateTime = {From = 12*60+20,To = 13*60 + 30 }
x310185_g_DeleteTime = {From = 19*60+30,To = 20*60 + 30 }


x310185_g_WulongNPC  =   { 
							{ SceneId=50,typeid =1182,guid= 141511,x = 139, z=34, facedir =0, name="乌龙主持人", title="乌龙辞典王国海选赛" }, 
						  { SceneId=50,typeid =1182,guid= 141511,x = 60, z=118, facedir =90,name="乌龙主持人", title="乌龙辞典王国海选赛" }, 
							{ SceneId=50,typeid =1182,guid= 141511,x = 193, z=118, facedir =270,name="乌龙主持人", title="乌龙辞典王国海选赛" }, 
							
							{ SceneId=150,typeid =1182,guid= 141511,x = 142, z=27, facedir =0, name="乌龙主持人", title="乌龙辞典王国海选赛" }, 
						  { SceneId=150,typeid =1182,guid= 141511,x = 60, z=118, facedir =90, name="乌龙主持人",title="乌龙辞典王国海选赛" }, 
							{ SceneId=150,typeid =1182,guid= 141511,x = 193, z=118, facedir =270, name="乌龙主持人",title="乌龙辞典王国海选赛" }, 

							
							{ SceneId=250,typeid =1182,guid= 141511,x = 116, z=212, facedir =90, name="乌龙主持人", title="乌龙辞典王国海选赛" }, 
							{ SceneId=250,typeid =1182,guid= 141511,x = 59, z=138, facedir =90, name="乌龙主持人",title="乌龙辞典王国海选赛" }, 
							{ SceneId=250,typeid =1182,guid= 141511,x = 193, z=138, facedir =270, name="乌龙主持人",title="乌龙辞典王国海选赛" }, 

							
							{ SceneId=350,typeid =1182,guid= 141511,x = 117, z=223, facedir =180, name="乌龙主持人",title="乌龙辞典王国海选赛" }, 
							{ SceneId=350,typeid =1182,guid= 141511,x = 59, z=138, facedir =90, name="乌龙主持人",title="乌龙辞典王国海选赛" }, 
							{ SceneId=350,typeid =1182,guid= 141511,x = 193, z=138, facedir =270, name="乌龙主持人",title="乌龙辞典王国海选赛" }, 

							-----------------
							--{ SceneId=0,typeid =1183,guid= 141512,x = 255, z=350, facedir =180, name="一号主持人",title="乌龙辞典大都淘汰赛" }, 
							--{ SceneId=0,typeid =1183,guid= 141512,x = 216, z=327, facedir =90, name="一号主持人",title="乌龙辞典大都淘汰赛" }, 
							--{ SceneId=0,typeid =1183,guid= 141512,x = 274, z=329, facedir =270, name="一号主持人",title="乌龙辞典大都淘汰赛" }, 
							--{ SceneId=0,typeid =1184,guid= 141513,x = 195, z=268, facedir =0, name="二号主持人",title="乌龙辞典大都淘汰赛" }, 							
							--{ SceneId=0,typeid =1184,guid= 141513,x = 315, z=268, facedir =0, name="二号主持人",title="乌龙辞典大都淘汰赛" }, 
							--{ SceneId=0,typeid =1185,guid= 141514,x = 255, z=231, facedir =0, name="三号主持人",title="乌龙辞典大都淘汰赛" }, 
							--{ SceneId=0,typeid =1186,guid= 141515,x = 195, z=186, facedir =0, name="四号主持人",title="乌龙辞典大都淘汰赛" }, 
							--{ SceneId=0,typeid =1187,guid= 141516,x = 178, z=102, facedir =180, name="五号主持人",title="乌龙辞典大都淘汰赛" }, 
              --
							--{ SceneId=0,typeid =1183,guid= 141517,x = 122, z=135, facedir =0, name="六号主持人",title="乌龙辞典大都淘汰赛" }, 
							--{ SceneId=0,typeid =1184,guid= 141518,x = 104, z=67, facedir =0, name="七号主持人",title="乌龙辞典大都淘汰赛" }, 
							--{ SceneId=0,typeid =1185,guid= 141519,x = 50, z=144, facedir =90, name="八号主持人",title="乌龙辞典大都淘汰赛" }, 
							--{ SceneId=0,typeid =1186,guid= 141520,x = 26, z=320, facedir =90, name="九号主持人",title="乌龙辞典大都淘汰赛" }, 
							--{ SceneId=0,typeid =1187,guid= 141521,x = 122, z=348, facedir =270, name="十号主持人",title="乌龙辞典大都淘汰赛" }, 
              --
							--{ SceneId=0,typeid =1183,guid= 141522,x = 70, z=375, facedir =270, name="十一号主持人",title="乌龙辞典大都淘汰赛" }, 
							--{ SceneId=0,typeid =1184,guid= 141523,x = 100, z=465, facedir =0, name="十二号主持人",title="乌龙辞典大都淘汰赛" }, 
							--{ SceneId=0,typeid =1185,guid= 141524,x = 181, z=464, facedir =270, name="十三号主持人",title="乌龙辞典大都淘汰赛" }, 
							--{ SceneId=0,typeid =1186,guid= 141525,x = 283, z=427, facedir =0, name="十四号主持人",title="乌龙辞典大都淘汰赛" }, 
							--{ SceneId=0,typeid =1187,guid= 141526,x = 415, z=449, facedir =270, name="十五号主持人",title="乌龙辞典大都淘汰赛" }, 
              --
							--{ SceneId=0,typeid =1183,guid= 141527,x = 459, z=347, facedir =180, name="十六号主持人",title="乌龙辞典大都淘汰赛" }, 
							--{ SceneId=0,typeid =1184,guid= 141528,x = 418, z=265, facedir =180, name="十七号主持人",title="乌龙辞典大都淘汰赛" }, 
							--{ SceneId=0,typeid =1185,guid= 141529,x = 419, z=103, facedir =0, name="十八号主持人",title="乌龙辞典大都淘汰赛" }, 
							--{ SceneId=0,typeid =1186,guid= 141530,x = 375, z=157, facedir =270, name="十九号主持人",title="乌龙辞典大都淘汰赛" }, 
							--{ SceneId=0,typeid =1187,guid= 141531,x = 225, z=123, facedir =90, name="二十号主持人",title="乌龙辞典大都淘汰赛" }
							
						}

x310185_g_WulongNPC_obj = {}


----------------------------------------------------------------------------------------------
--乌龙辞典相关NPC清空
----------------------------------------------------------------------------------------------
function x310185_WulongNPC_Cleanup( SceneId,why )

	----------------------------------------------------------------------------------------------
	--时间检查
	----------------------------------------------------------------------------------------------
	if GetWeek() ~= 0 then
		return
	end

	if SceneId ~= 50 and SceneId ~= 150 and SceneId ~=250 and SceneId ~= 350 and SceneId ~= 0 then
		return 
	end
	
	----------------------------------------------------------------------------------------------
	--记录是此函数被调用的原因
	----------------------------------------------------------------------------------------------
	local strMsg = format("WLL:<Info>x310185_WulongNPC_Cleanup sceneId = %d,why=%d ",SceneId ,why)
    WriteLog( 1, strMsg )
	
	----------------------------------------------------------------------------------------------
	--开始删除有效的NPC
	----------------------------------------------------------------------------------------------
	for i,itm in x310185_g_WulongNPC_obj do
		if IsObjValid(SceneId,itm[2]) == 1 and GetHp(SceneId,itm[2]) > 0  then
			
			DeleteMonster(SceneId,itm[2])
			
			--删除一个Monster,记一个日志
			strMsg = format("WLL:<Info>x310185_WulongNPC_Cleanup sceneId = %d,obj=%d ",SceneId ,itm[2])
			WriteLog( 1, strMsg )
			
		end
	end
	
	----------------------------------------------------------------------------------------------
	--清空列表
	----------------------------------------------------------------------------------------------
	x310185_g_WulongNPC_obj = {}
end

----------------------------------------------------------------------------------------------
--乌龙辞典NPC触发
----------------------------------------------------------------------------------------------
function x310185_OnTimerDoingStart( SceneId, actId, Param1, Param2, Param3, Param4, Param5 )
	
	----------------------------------------------------------------------------------------------
	--基本检查,一个是检查星期,一个是检查场景
	----------------------------------------------------------------------------------------------
	if GetWeek() ~= 0 then
		return
	end

	if SceneId ~= 50 and SceneId ~= 150 and SceneId ~=250 and SceneId ~= 350 and SceneId ~= 0 then
		return 
	end
	
	
	----------------------------------------------------------------------------------------------
	--如果检查已经创建的辞典NPC列表为空,则表示当前是创建NPC流程,则开始执行创建流程.
	----------------------------------------------------------------------------------------------
	local strMsg = format("WLL:<Info>x310185_OnTimerDoingStart sceneId = %d ",SceneId )
    WriteLog( 1, strMsg )
	
	local nMin = GetMinOfDay()
	
	
	----------------------------------------------------------------------------------------------
	--如果是删怪流程
	----------------------------------------------------------------------------------------------
	if nMin >= x310185_g_DeleteTime.From and nMin <= x310185_g_DeleteTime.To then
	
		--先检查已经创建的辞典NPC列表是否为空,如果为空,那么,当前操作是清空流程,
		--执行完清空流程之后,则可以退出.
		local nCurrentNpcCount = getn(x310185_g_WulongNPC_obj)
		if nCurrentNpcCount > 0 then
			x310185_WulongNPC_Cleanup(SceneId,0)	
			return
		end
	end
	
	----------------------------------------------------------------------------------------------
	--如果不是创建怪的流程,退出
	----------------------------------------------------------------------------------------------
	if nMin < x310185_g_CreateTime.From and nMin > x310185_g_CreateTime.To then
		return
	end
	
	WULONGCIDIAN_STEPIN_NAME				={}
	WULONGCIDIAN_STEPIN_TIME				={}
	WULONGCIDIAN_STEPIN_COUNT			=0

	WULONGCIDIAN_AWARD_NAME				={}
	WULONGCIDIAN_AWARD_TIME				={}
	WULONGCIDIAN_AWARD_COUNT			=0
	WULONGCIDIAN_AWARD_Draw				={}
	
	
	local monsterchecklist = {}
	local monstercreateinfolist = {}
	local monstercount = 0

	for i, item in x310185_g_WulongNPC do
	
		if item.SceneId == SceneId then
			
			-- 开始创建NPC
			local objId,objGUID = CreateMonster(SceneId, item.typeid, item.x, item.z, 3, 0, -1, item.guid, -1,	-1,item.facedir, item.name, item.title)
			
			--判断OBJ是否创建成功
			if objId < 0 then
				local strMsg2 = format("WLL:<Info>Invalid obj  sceneId = %d objId =%d guid=%d",SceneId, objId,objGUID )
    			WriteLog( 1, strMsg2 )
			end
			
			--记录
			monstercount = monstercount + 1
			monsterchecklist[monstercount] = objId
			monstercreateinfolist[monstercount] = i
			
			--记录NPC和索引信息
			x310185_g_WulongNPC_obj[monstercount] = {i,objId}
			
			--创建成功,简单的记一下日志
			local msg = format("WLL:<Info>CreateMonster OK,sceneId=%d,objId=%d,guid=%d,create_index=%d",SceneId,objId, objGUID,i)
			WriteLog( 1, msg )
			
		end
	end
	
	
	----------------------------------------------------------------------------------------------
	--检查创建流程
	----------------------------------------------------------------------------------------------
	if monstercount <= 0 then
	
		--没有一个怪被创建出来,则记个大的日志
		local msg = format("WLL:<Info>CreateMonster Failed 0,sceneId=%d,",SceneId)
		WriteLog( 1, msg )
		
	else
	
		--检查所有创建出来的OBJ是否有效
		for i = 1,monstercount do
			
			--如果之前创建的无效,则这里再创建一次
			if IsObjValid(SceneId,monsterchecklist[i]) ~= 1 then
			
				local item = x310185_g_WulongNPC[monstercreateinfolist[i]]				
				local objId,guid = CreateMonster(SceneId, item.typeid, item.x, item.z, 3, 0, -1, item.guid, -1,	5*60*60*1000,item.facedir, item.name, item.title)
				
				local msg = format("WLL:<Info>CreateMonster Failed 1,sceneId=%d,objId=%d,objGUID=%d",SceneId,objId,guid)
				WriteLog( 1, msg )
			end
		end
	end
	
	
	----------------------------------------------------------------------------------------------
	--启动检查Timer
	----------------------------------------------------------------------------------------------
	SetSystemTimerTick( SceneId, x310185_g_ScriptId, "OnCheckTimer", actId, 300*1000 )
end



----------------------------------------------------------------------------------------------
--活动的检查Tick
----------------------------------------------------------------------------------------------
function x310185_OnCheckTimer( sceneId, actId, uTime )

	local msg = format("WLL:<Info>x310185_OnCheckTimer ,sceneId=%d",sceneId)
	WriteLog( 1, msg )

	--遍历检查
	for i,item in x310185_g_WulongNPC_obj do
		
		local index = item[1]
		local objId = item[2]
		
		local bValid = IsObjValid(sceneId,objId)
		local nHp = 0
		if bValid == 1 then
			nHp = GetHp(sceneId,objId)
		end
		
		
		local sx = x310185_g_WulongNPC[index].x
		local sz = x310185_g_WulongNPC[index].z
		
		if bValid ==1 and nHp > 0 then
			
			--校正位置
			local x,z = GetWorldPos(sceneId,objId)
			
			
			
			--如果位置不对
			if x ~= sx or z ~= sz then
				SetPos(sceneId,sceneId,objId,sx,sz)
				
				msg = format("WLL:<Error>Monster Position Error sceneId=%d,index = %d x=%d,z=%d,sx = %d,sz = %d ",sceneId,index,x,z,sx,sz)
				WriteLog( 1, msg )
			end
		else
			
			--ID无效
			if bValid ~= 1 then
				
				msg = format("WLL:<Error>Monster Position not valid sceneId=%d, index = %d,sx = %d,sz = %d ",sceneId,index,sx,sz)
				WriteLog( 1, msg )

			end
			
			--血量无效
			if nHp <= 0 then
				
				msg = format("WLL:<Error>Monster Position (hp<=0) sceneId=%d, index = %d ,sx = %d,sz = %d ",sceneId,index,sx,sz)
				WriteLog( 1, msg )
			end
		end
	end
	
	--到达删怪时间,则不必再设置下一次检查触发
	local nMin = GetMinOfDay()
	if nMin >= x310185_g_DeleteTime.From and nMin <= x310185_g_DeleteTime.To then
		return
	end
	
	
	--设置下一次触发
	SetSystemTimerTick( sceneId, x310185_g_ScriptId, "OnCheckTimer", actId, 300*1000 )
	
end